<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reproductor de TV</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, sans-serif;
            background-color: #1e1e1e;
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .video-container {
            height: 40vh;
            width: 100%;
            background: #000;
            position: relative;
            margin-top: 10px;
            transition: height 0.3s ease;
        }
        .video-container.expanded {
            height: 85vh;
        }
        #videoElement {
            width: 100%;
            height: 100%;
            background: #000;
        }
        #platformFrame {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }
        .channel-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            max-width: 80%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .channel-list {
            flex: 1;
            overflow-y: auto;
            background: #2c2c2c;
            padding: 10px;
        }
        .channel-item {
            padding: 12px 8px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .channel-item:hover {
            background: #3c3c3c;
        }
        .channel-item.selected {
            background-color: #4CAF50;
            color: white;
        }
        .button.multiselect-active {
            background: #4CAF50;
        }
        .button.multiselect-inactive {
            background: #f44336;
        }
        .tv-channel-number {
    position: absolute;
    bottom: 0px; /* Posición en la parte inferior */
    left: 90%; /* Centrado horizontal */
    transform: translateX(95%); /* Centrado preciso */
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 30px 30px;
    border-radius: 10px;
    font-size: 38px;
    font-weight: bold;
    z-index: 10000;
    pointer-events: none;
    text-align: center;
    min-width: 60px; /* Ancho mínimo para mejor apariencia */
}
        .channel-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            font-weight: bold;
        }
        .channel-type {
            font-size: 10px;
            background: #666;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }
        .favorite-toggle {
            width: 24px;
            height: 24px;
            border: 1px solid #666;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            cursor: pointer;
            background: #444;
        }
        .favorite-toggle.active {
            background: #ffeb3b;
            color: black;
        }
        .buttons-container {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background: #2c2c2c;
            flex-wrap: wrap;
            position: relative;
            border-top: 1px solid #444;
        }
        .cleanup-button {
    background: #ff5722 !important;
    color: white !important;
}
        .button {
            padding: 8px 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 4px;
            flex-grow: 1;
            max-width: 15%;
            min-width: 65px;
        }
        .button:active {
            background: #3e8e41;
        }
        .button.secondary {
            background: #f0ad4e;
            color: black;
        }
        .button.secondary:active {
            background: #ec971f;
            color: black;
        }
        .button.tv-mode {
            background: #1565c0 !important;
            color: #fff !important;
        }
        .channel-counter {
            padding: 8px 12px;
            margin: 2px;
            font-weight: bold;
            color: #fff;
            text-align: center;
            background: #444;
            border-radius: 4px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #2c2c2c;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            color: #fff;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .modal-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #444;
            border-radius: 4px;
            background: #3c3c3c;
            color: #fff;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        .modal-button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .modal-button.primary {
            background: #4CAF50;
            color: white;
        }
        .modal-button.secondary {
            background: #f44336;
            color: white;
        }
        .search-container {
            display: none;
            padding: 10px;
            background: #2c2c2c;
            border-bottom: 1px solid #444;
        }
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #3c3c3c;
            color: #fff;
        }
        .secondary-buttons {
            display: none;
            width: 100%;
            flex-wrap: wrap;
            justify-content: space-around;
        }
        .show-secondary {
            display: flex;
        }
        .tv-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 10px 0;
        }
        .tv-scroll-btn {
            font-size: 1.6em;
            background: #1565c0;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 10px 22px;
            margin: 0 20px;
            cursor: pointer;
            user-select: none;
        }
        .tv-scroll-btn:active {
            background: #004ba0;
        }
        .fullscreen-btn {
            background: #1976d2 !important;
            color: #fff !important;
            font-size: 1em;
            margin-left: 8px;
            min-width: 70px;
        }
        .play-btn-tv {
            background: #43a047 !important;
            color: #fff !important;
            font-size: 1em;
            margin-left: 8px;
            min-width: 90px;
        }
        .hidden {
            display: none !important;
        }
        .platform-filter-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 6px 0 0 0;
        }
        .platform-filter-select {
            padding: 7px 16px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #222;
            color: #fff;
            font-size: 1em;
            margin: 0 0 10px 0;
        }
        .platform-filter-label {
            margin-right: 10px;
            font-size: 1em;
            color: #eee;
        }
        .navigation-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: none;
            z-index: 10000;
            flex-direction: row;
            gap: 10px;
        }
        .nav-btn {
            padding: 20px 10px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            font-size: 9px;
            min-width: 30px;
        }
        .prev-btn {
            background-color: #2196F3;
            color: white;
        }
        .next-btn {
            background-color: #4CAF50;
            color: white;
        }
        .toggle-nav-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 20px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10001;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .toggle-nav-btn.off {
            background-color: #f44336;
            color: white;
        }
        .toggle-nav-btn.on {
            background-color: #4CAF50;
            color: black;
        }
        #fileInput {
            position: absolute;
            left: -9999px;
            opacity: 0;
            width: 0;
            height: 0;
            overflow: hidden;
        }
        .toggle-list-btn {
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
            padding: 12px;
            background-color: #333;
            color: white;
            border: none;
            border-bottom: 1px solid #555;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
        }
        .toggle-list-btn:hover {
            background-color: #444;
        }
        .channel-list.collapsed {
            display: none;
        }
    </style>
</head>
<body>
    <div class="video-container">
        <video id="videoElement" controls></video>
        <iframe id="platformFrame" allowfullscreen></iframe>
        <div class="channel-info" id="channelInfo"></div>
        <div class="tv-channel-number" id="tvChannelNumber" style="display: none;"></div>
        
    </div>
    <button class="toggle-nav-btn off" id="toggleNavBtn">OFF</button>
    <div class="navigation-controls" id="navigationControls">
    	<button class="button fullscreen-btn" id="fullscreenBtn" tabindex="3">F.S</button>
        <button class="nav-btn prev-btn" id="prevBtn">Ant</button>
        <button class="nav-btn next-btn" id="nextBtn">Sig</button>
    </div>
    <div class="tv-controls" id="tvControls" style="display:none;">
        <button class="tv-scroll-btn" id="scrollUpBtn" tabindex="1">▲</button>
        <button class="button tv-mode" id="tvModeButton" tabindex="2">Modo TV</button>
        <button class="play-btn-tv" id="playBtnTv" tabindex="4">Play</button>
        <button class="button fullscreen-btn" id="fullscreenBtn" tabindex="3">FullScreen</button>
        <button class="tv-scroll-btn" id="scrollDownBtn" tabindex="5">▼</button>
    </div>

        <div class="buttons-container" id="buttonsContainer">
        <button class="button" id="loadButton">Cargar</button>
        <button class="button" id="searchButton">Buscar</button>
        <button class="button tv-mode" id="tvModeButtonAndroid">Modo TV</button>
        <button class="button fullscreen-btn" id="fullscreenBtnAndroid">FullSc</button>
        <button class="button" id="moreButton">Más</button>
        <div class="secondary-buttons" id="secondaryButtons">
        	<button class="button cleanup-button" id="cleanupButton">Limpiar Inválidos</button>
            <button class="button" id="saveButton">Guardar</button>
            <button class="button" id="favButton">Favoritos</button>
            <button class="button" id="allButton">Todos</button>
            <button class="button secondary" id="urlButton">URL</button>
            <button class="button secondary" id="addButton">Añadir</button>
            <button class="button secondary" id="editButton">Editar</button>
            <button class="button secondary" id="removeButton">Quitar</button>
            <button class="button" id="selectAllButton">Selecfull</button>
            <button class="button" id="deselectAllButton">Deselfull</button>
            <button class="button" id="repSelecButton">RepSelec</button>
                <button class="button secondary" id="resumeButton">Seguir</button>
            <button class="button secondary" id="timerButton">Tempor</button>
            <div class="platform-filter-container">
                <label for="platformFilterSelect" class="platform-filter-label">Filtrar plataforma:</label>
                <select id="platformFilterSelect" class="platform-filter-select">
                    <option value="all">Todas</option>
                    <option value="youtube">YouTube</option>
                    <option value="dailymotion">Dailymotion</option>
                    <option value="okru">ok.ru</option>
                    <option value="TV">TV</option>
                </select>
            </div>
            <div class="channel-counter" id="channelCounter">Canales: 0</div>
        </div>
    </div>
    <div class="search-container" id="searchContainer">
        <input type="text" class="search-input" id="searchInput" placeholder="Buscar canales...">
    </div>
    <button class="toggle-list-btn" id="toggleListBtn">▼ Ocultar Lista</button>
    <div class="channel-list" id="channelList">
        <!-- La lista se poblará dinámicamente -->
    </div>
    <input type="file" id="fileInput" accept=".txt,.md,.m3u,.m3u8,.json,.JSON">
    <div class="modal" id="urlModal">
        <div class="modal-content">
            <h3>Introduce la URL de la lista</h3>
            <input type="text" class="modal-input" id="urlInput" placeholder="https://ejemplo.com/lista.m3u o .json">
            <div class="modal-buttons">
                <button class="modal-button primary" id="downloadButton">Descargar</button>
                <button class="modal-button secondary" id="cancelButton">Cancelar</button>
            </div>
        </div>
    </div>
    <div class="modal" id="timerModal">
        <div class="modal-content">
            <h3>Temporizador de reproducción (minutos)</h3>
            <input type="number" class="modal-input" id="timerInput" min="1" placeholder="Minutos">
            <div class="modal-buttons">
                <button class="modal-button primary" id="setTimerButton">Aceptar</button>
                <button class="modal-button secondary" id="cancelTimerButton">Cancelar</button>
            </div>
        </div>
    </div>
    <div class="modal" id="addChannelModal">
        <div class="modal-content">
            <h3 id="addEditModalTitle">Añadir nuevo canal</h3>
            <input type="text" class="modal-input" id="channelNameInput" placeholder="Nombre del canal">
            <input type="text" class="modal-input" id="channelUrlInput" placeholder="URL del canal">
            <div class="modal-buttons">
                <button class="modal-button primary" id="addChannelButton">Añadir</button>
                <button class="modal-button secondary" id="cancelAddChannelButton">Cancelar</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
    // Variables globales
    let lastPlaybackPosition = 0;
let playbackPositionSaved = false;
let connectionErrorDetected = false;
    let navigationEnabled = false;
    let currentChannelIndex = -1;
    let isListExpanded = false;
    let channelsData = [];
    let hls = null;
    let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
    let selectedChannels = [];
    let currentSelectedChannel = null;
    let currentDisplayMode = 'all';
    let currentSearchTerm = '';
    let channelStatuses = {};
    let isUsingPlatformPlayer = false;
    let isEditMode = false;
    let editChannelIndex = null;
    let tvMode = false;
    let currentPlatformFilter = 'all';
    let repSelecIndex = 0;
    let repSelecPlaying = false;
    let timerTimeout = null;
    const DEFAULT_LIST_URL = "https://yagopc.github.io/Cine/doctv.m3u";
    let isUsingDefaultList = false;
    // Elementos del DOM
    const toggleNavBtn = document.getElementById('toggleNavBtn');
    const navigationControls = document.getElementById('navigationControls');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const loadButton = document.getElementById('loadButton');
    const saveButton = document.getElementById('saveButton');
    const favButton = document.getElementById('favButton');
    const allButton = document.getElementById('allButton');
    const searchButton = document.getElementById('searchButton');
    const urlButton = document.getElementById('urlButton');
    const addButton = document.getElementById('addButton');
    const editButton = document.getElementById('editButton');
    const removeButton = document.getElementById('removeButton');
    const selectAllButton = document.getElementById('selectAllButton');
    const deselectAllButton = document.getElementById('deselectAllButton');
    const fileInput = document.getElementById('fileInput');
    const channelList = document.getElementById('channelList');
    const videoElement = document.getElementById('videoElement');
    const platformFrame = document.getElementById('platformFrame');
    const channelInfo = document.getElementById('channelInfo');
    const urlModal = document.getElementById('urlModal');
    const urlInput = document.getElementById('urlInput');
    const downloadButton = document.getElementById('downloadButton');
    const cancelButton = document.getElementById('cancelButton');
    const searchContainer = document.getElementById('searchContainer');
    const searchInput = document.getElementById('searchInput');
    const channelCounter = document.getElementById('channelCounter');
    const addChannelModal = document.getElementById('addChannelModal');
    const channelNameInput = document.getElementById('channelNameInput');
    const channelUrlInput = document.getElementById('channelUrlInput');
    const addChannelButton = document.getElementById('addChannelButton');
    const cancelAddChannelButton = document.getElementById('cancelAddChannelButton');
    const moreButton = document.getElementById('moreButton');
    const secondaryButtons = document.getElementById('secondaryButtons');
    const tvModeButton = document.getElementById('tvModeButton');
    const tvModeButtonAndroid = document.getElementById('tvModeButtonAndroid');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const fullscreenBtnAndroid = document.getElementById('fullscreenBtnAndroid');
    const tvControls = document.getElementById('tvControls');
    const scrollUpBtn = document.getElementById('scrollUpBtn');
    const scrollDownBtn = document.getElementById('scrollDownBtn');
    const addEditModalTitle = document.getElementById('addEditModalTitle');
    const playBtnTv = document.getElementById('playBtnTv');
    const platformFilterSelect = document.getElementById('platformFilterSelect');
        function toggleSecondaryButtons() {
        if (secondaryButtons.classList.contains('show-secondary')) {
            secondaryButtons.classList.remove('show-secondary');
            moreButton.textContent = 'Más';
        } else {
            secondaryButtons.classList.add('show-secondary');
            moreButton.textContent = 'Menos';
        }
    }
    
    function updateTvChannelNumber() {
    const tvChannelNumber = document.getElementById('tvChannelNumber');
    
    if (!tvMode || !currentSelectedChannel) {
        tvChannelNumber.style.display = 'none';
        return;
    }
    
    const filteredChannels = getCurrentFilteredChannels();
    const channelIndex = filteredChannels.findIndex(
        ch => ch.url === currentSelectedChannel.url && ch.name === currentSelectedChannel.name
    );
    
    if (channelIndex !== -1) {
        tvChannelNumber.textContent = `#${channelIndex + 1}`;
        tvChannelNumber.style.display = 'block';
    } else {
        tvChannelNumber.style.display = 'none';
    }
}
    function toggleChannelList() {
        isListExpanded = !isListExpanded;
        if (isListExpanded) {
            channelList.classList.add('collapsed');
            document.querySelector('.video-container').classList.add('expanded');
            toggleListBtn.textContent = '▲ Mostrar Lista';
        } else {
            channelList.classList.remove('collapsed');
            document.querySelector('.video-container').classList.remove('expanded');
            toggleListBtn.textContent = '▼ Ocultar Lista';
        }
    }
    function scrollChannelList(direction) {
        const items = Array.from(channelList.querySelectorAll('.channel-item'));
        const selected = items.findIndex(item => item.classList.contains('selected'));
        let nextIndex = 0;
        if (direction === 'up') {
            nextIndex = selected <= 0 ? 0 : selected - 1;
        } else {
            nextIndex = selected === -1 ? 0 : Math.min(items.length - 1, selected + 1);
        }
        items.forEach(item => item.classList.remove('selected'));
        if (items[nextIndex]) {
            items[nextIndex].classList.add('selected');
            items[nextIndex].scrollIntoView({block:'center'});
            currentSelectedChannel = getCurrentFilteredChannels()[nextIndex] || null;
        }
        updateSelectedChannels();
    }
    function enterFullscreen() {
        if (!isUsingPlatformPlayer && videoElement.style.display !== "none") {
            if (videoElement.requestFullscreen) videoElement.requestFullscreen();
            else if (videoElement.mozRequestFullScreen) videoElement.mozRequestFullScreen();
            else if (videoElement.webkitRequestFullscreen) videoElement.webkitRequestFullscreen();
            else if (videoElement.msRequestFullscreen) videoElement.msRequestFullscreen();
        } else if (isUsingPlatformPlayer && platformFrame.style.display !== "none") {
            if (platformFrame.requestFullscreen) platformFrame.requestFullscreen();
            else if (platformFrame.mozRequestFullScreen) platformFrame.mozRequestFullScreen();
            else if (platformFrame.webkitRequestFullscreen) platformFrame.webkitRequestFullscreen();
            else if (platformFrame.msRequestFullscreen) platformFrame.msRequestFullscreen();
        }
    }
    function playSelectedChannelFromTV() {
        const items = Array.from(channelList.querySelectorAll('.channel-item'));
        const sel = items.find(item => item.classList.contains('selected'));
        if (sel) {
            const name = sel.querySelector('.channel-name').textContent;
            const filtered = getCurrentFilteredChannels();
            const channel = filtered.find(ch => ch.name === name);
            if (channel) {
                playChannel(channel);
            }
        } else {
            alert('Selecciona un canal con las flechas antes de pulsar Play.');
        }
    }
 function setMode(tv) {
    tvMode = tv;
    if (tvMode) {
        updateTvChannelNumber();
        document.getElementById('buttonsContainer').classList.add('hidden');
        tvControls.style.display = 'flex';
        searchButton.classList.remove('hidden');
        searchContainer.style.display = 'block';
        tvModeButton.textContent = 'Modo Android';
        playBtnTv.classList.remove('hidden');
        
        // Asegurar que la navegación esté desactivada cuando se activa el modo TV
        if (navigationEnabled) {
            navigationEnabled = false;
            toggleNavBtn.textContent = 'OFF';
            toggleNavBtn.classList.remove('on');
            toggleNavBtn.classList.add('off');
            document.getElementById('tvChannelNumber').style.display = 'none';
            toggleInterface();
        }
    } else {
        document.getElementById('tvChannelNumber').style.display = 'none';
        document.getElementById('buttonsContainer').classList.remove('hidden');
        tvControls.style.display = 'none';
        searchContainer.style.display = 'none';
        tvModeButtonAndroid.textContent = 'Modo TV';
        playBtnTv.classList.add('hidden');
        
        // Asegurar que la navegación esté desactivada cuando se desactiva el modo TV
        if (navigationEnabled) {
            navigationEnabled = false;
            toggleNavBtn.textContent = 'OFF';
            toggleNavBtn.classList.remove('on');
            toggleNavBtn.classList.add('off');
            document.getElementById('tvChannelNumber').style.display = 'none';
            toggleInterface();
        }
    }
}
    function handleTvModeSwitch() {
    setMode(!tvMode);
    // Si se está desactivando el modo TV y la navegación está activa, desactivarla también
    if (!tvMode && navigationEnabled) {
        navigationEnabled = false;
        toggleNavBtn.textContent = 'OFF';
        toggleNavBtn.classList.remove('on');
        toggleNavBtn.classList.add('off');
        document.getElementById('tvChannelNumber').style.display = 'none';
        toggleInterface();
    }
}
    function updateSelectedChannels() {
        selectedChannels = [];
        document.querySelectorAll('.channel-item.selected').forEach(item => {
            const channelName = item.querySelector('.channel-name').textContent;
            const filtered = getCurrentFilteredChannels();
            const channel = filtered.find(ch => ch.name === channelName);
            if (channel) selectedChannels.push(channel);
        });
    }
    function savePlaybackPosition() {
    if (!isUsingPlatformPlayer && videoElement.currentTime > 0) {
        lastPlaybackPosition = videoElement.currentTime;
        playbackPositionSaved = true;
        localStorage.setItem('lastPlaybackPosition', lastPlaybackPosition);
        localStorage.setItem('lastPlaybackChannel', JSON.stringify(currentSelectedChannel));
        alert('Posición guardada. Puedes continuar más tarde.');
    } else if (isUsingPlatformPlayer) {
        alert('No se puede guardar posición en reproductores de plataforma externa.');
    } else {
        alert('No hay reproducción activa para guardar.');
    }
}
function resumePlayback() {
    const savedPosition = localStorage.getItem('lastPlaybackPosition');
    const savedChannel = localStorage.getItem('lastPlaybackChannel');
    
    if (!savedPosition || !savedChannel) {
        alert('No hay posición guardada para continuar.');
        return;
    }
    
    try {
        const channel = JSON.parse(savedChannel);
        lastPlaybackPosition = parseFloat(savedPosition);
        
        // Reproducir el canal guardado
        playChannel(channel);
        
        // Una vez que el video cargue, establecer la posición
        videoElement.oncanplay = function() {
            videoElement.currentTime = lastPlaybackPosition;
            videoElement.oncanplay = null; // Eliminar el event listener
            playbackPositionSaved = false;
            alert(`Continuando desde el minuto ${Math.floor(lastPlaybackPosition / 60)}:${Math.floor(lastPlaybackPosition % 60).toString().padStart(2, '0')}`);
        };
    } catch (e) {
        console.error('Error al restaurar la posición:', e);
        alert('Error al restaurar la posición guardada.');
    }
}
    function saveSelectedChannels() {
        if (selectedChannels.length === 0) {
            alert('No hay canales seleccionados para guardar');
            return;
        }
        let m3uContent = '#EXTM3U\n';
        selectedChannels.forEach(channel => {
            m3uContent += `#EXTINF:-1 tvg-id="${channel.name.replace(/"/g, '')}" tvg-name="${channel.name.replace(/"/g, '')}" tvg-logo="${channel.logo || ''}" group-title="${channel.group || 'Seleccionados'}",${channel.name}\n`;
            m3uContent += `${channel.url}\n`;
        });
        const blob = new Blob([m3uContent], { type: 'application/x-mpegURL' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'canales_seleccionados.m3u';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert(`Se han guardado ${selectedChannels.length} canales seleccionados`);
    }
    function selectAllChannels() {
        document.querySelectorAll('.channel-item').forEach(item => item.classList.add('selected'));
        updateSelectedChannels();
    }
    function deselectAllChannels() {
        document.querySelectorAll('.channel-item').forEach(item => item.classList.remove('selected'));
        currentSelectedChannel = null;
        selectedChannels = [];
        if (hls) { hls.destroy(); hls = null; }
        videoElement.src = '';
        platformFrame.src = '';
        channelInfo.textContent = '';
    }
    function saveChannelsData() {
        localStorage.setItem('channelsData', JSON.stringify(channelsData));
        isUsingDefaultList = false;
    }
    function loadChannelsData() {
        try {
            const saved = localStorage.getItem('channelsData');
            if (saved) {
                channelsData = JSON.parse(saved);
                if (channelsData && channelsData.length > 0) {
                    isUsingDefaultList = false;
                    return true;
                } else {
                    channelsData = [];
                    return false;
                }
            }
            return false;
        } catch (e) {
            channelsData = [];
            return false;
        }
    }
    
    
    
    function handleSearchInput() {
        currentSearchTerm = searchInput.value.trim().toLowerCase();
        if (currentSearchTerm === '') {
            displayChannels(getCurrentFilteredChannels());
            return;
        }
        const filteredChannels = getCurrentFilteredChannels().filter(channel =>
            channel.name.toLowerCase().includes(currentSearchTerm)
        );
        displayChannels(filteredChannels);
        updateChannelCounter();
    }
    function updateCurrentFileName() {
        if (currentChannelIndex >= 0) {
            const filteredChannels = getCurrentFilteredChannels();
            const currentChannel = filteredChannels[currentChannelIndex];
            const displayName = currentChannel.name.length > 40 
                ? currentChannel.name.substring(0, 40) + '...' 
                : currentChannel.name;
            channelInfo.textContent = displayName;
        }
    }
    function showFavorites() {
        currentDisplayMode = 'fav';
        searchContainer.style.display = 'none';
        displayChannels(getCurrentFilteredChannels());
        updateChannelCounter();
    }
    function showAllChannels() {
        currentDisplayMode = 'all';
        searchContainer.style.display = 'none';
        displayChannels(getCurrentFilteredChannels());
        updateChannelCounter();
    }
    function toggleSearch() {
        if (searchContainer.style.display === 'block') {
            searchContainer.style.display = 'none';
            currentDisplayMode = 'all';
            displayChannels(getCurrentFilteredChannels());
        } else {
            searchContainer.style.display = 'block';
            searchInput.focus();
            currentDisplayMode = 'search';
        }
        updateChannelCounter();
    }
    function showUrlModal() {
        urlModal.style.display = 'flex';
        urlInput.focus();
    }
    function hideUrlModal() {
        urlModal.style.display = 'none';
        urlInput.value = '';
    }
    function showAddChannelModal() {
        isEditMode = false;
        editChannelIndex = null;
        addEditModalTitle.textContent = "Añadir nuevo canal";
        addChannelButton.textContent = "Añadir";
        channelNameInput.value = "";
        channelUrlInput.value = "";
        addChannelModal.style.display = 'flex';
        channelNameInput.focus();
    }
    function hideAddChannelModal() {
        addChannelModal.style.display = 'none';
        channelNameInput.value = '';
        channelUrlInput.value = '';
        isEditMode = false;
        editChannelIndex = null;
    }
    
    function isInvalidChannel(channel) {
    // Verificar si el canal es privado, borrado o tiene datos erróneos
    const invalidPatterns = [
        /\[Private video\]/i,
        /\[Deleted video\]/i,
        /\[Video eliminado\]/i,
        /private/i,
        /deleted/i,
        /eliminado/i,
        /error/i,
        /no disponible/i,
        /not available/i,
        /null/i,
        /undefined/i
    ];
    
    // Verificar nombre del canal
    if (!channel.name || invalidPatterns.some(pattern => pattern.test(channel.name))) {
        return true;
    }
    
    // Verificar URL del canal
    if (!channel.url || invalidPatterns.some(pattern => pattern.test(channel.url))) {
        return true;
    }
    
    return false;
}
    function showEditChannelModal() {
        let channelToEdit = null;
        let idx = -1;
        if (selectedChannels.length === 1) {
            channelToEdit = selectedChannels[0];
            idx = channelsData.findIndex(c => c.url === channelToEdit.url && c.name === channelToEdit.name);
        } else if (currentSelectedChannel) {
            channelToEdit = currentSelectedChannel;
            idx = channelsData.findIndex(c => c.url === channelToEdit.url && c.name === channelToEdit.name);
        }
        if (!channelToEdit || idx === -1) {
            alert('Selecciona un canal para editar.');
            return;
        }
        isEditMode = true;
        editChannelIndex = idx;
        addEditModalTitle.textContent = "Editar canal";
        addChannelButton.textContent = "Guardar";
        channelNameInput.value = channelToEdit.name;
        channelUrlInput.value = channelToEdit.url;
        addChannelModal.style.display = 'flex';
        channelNameInput.focus();
    }
    function addOrEditChannel() {
        const name = channelNameInput.value.trim();
        const url = channelUrlInput.value.trim();
        if (!name || !url) {
            alert('Por favor introduce tanto el nombre como la URL del canal');
            return;
        }
        if (isEditMode && editChannelIndex !== null) {
            channelsData[editChannelIndex].name = name;
            channelsData[editChannelIndex].url = url;
            const favIdx = favorites.findIndex(fav => fav.url === currentSelectedChannel.url && fav.name === currentSelectedChannel.name);
            if (favIdx !== -1) {
                favorites[favIdx].name = name;
                favorites[favIdx].url = url;
                localStorage.setItem('favorites', JSON.stringify(favorites));
            }
            saveChannelsData();
            updateChannelsDisplayByFilter();
            hideAddChannelModal();
            isEditMode = false;
            editChannelIndex = null;
        } else {
            const newChannel = { name, url, group: 'Manual', logo: '' };
            channelsData.push(newChannel);
            saveChannelsData();
            updateChannelsDisplayByFilter();
            hideAddChannelModal();
        }
    }
    function toggleInterface() {
        const videoContainer = document.querySelector('.video-container');
        const channelList = document.getElementById('channelList');
        const buttonsContainer = document.getElementById('buttonsContainer');
        const searchContainer = document.getElementById('searchContainer');
        const toggleListBtn = document.getElementById('toggleListBtn');
        const tvControls = document.getElementById('tvControls');
        const fileInput = document.getElementById('fileInput');
        if (navigationEnabled) {
            channelList.style.display = 'none';
            buttonsContainer.style.display = 'none';
            searchContainer.style.display = 'none';
            toggleListBtn.style.display = 'none';
            tvControls.style.display = 'none';
            fileInput.style.display = 'none';
            videoContainer.style.height = '85vh';
            navigationControls.style.display = 'flex';
            navigationControls.style.flexDirection = 'row';
            channelInfo.style.display = 'block';
            channelInfo.style.position = 'fixed';
            channelInfo.style.bottom = '30px';
            channelInfo.style.left = '50%';
            channelInfo.style.transform = 'translateX(-50%)';
            channelInfo.style.background = 'rgba(0,0,0,0.8)';
            channelInfo.style.padding = '10px 20px';
            channelInfo.style.borderRadius = '20px';
            channelInfo.style.zIndex = '10001';
            channelInfo.style.textAlign = 'center';
            channelInfo.style.minWidth = '200px';
            toggleNavBtn.style.display = 'block';
            toggleNavBtn.style.zIndex = '10002';
        } else {
            channelList.style.display = 'block';
            buttonsContainer.style.display = 'flex';
            searchContainer.style.display = 'none';
            toggleListBtn.style.display = 'block';
            fileInput.style.display = 'block';
            videoContainer.style.height = '40vh';
            navigationControls.style.display = 'none';
            tvControls.style.display = 'none';
            channelInfo.style.display = 'block';
            channelInfo.style.position = 'absolute';
            channelInfo.style.bottom = '10px';
            channelInfo.style.left = '10px';
            channelInfo.style.transform = 'none';
            channelInfo.style.background = 'rgba(0,0,0,0.7)';
            channelInfo.style.padding = '8px 12px';
            channelInfo.style.borderRadius = '4px';
            channelInfo.style.zIndex = '1';
            channelInfo.style.textAlign = 'left';
            channelInfo.style.minWidth = 'auto';
            toggleNavBtn.style.zIndex = '10000';
        }
    }
        function removeSelectedChannel() {
        if (selectedChannels.length > 0) {
            if (!confirm(`¿Seguro que deseas eliminar ${selectedChannels.length} canal(es) seleccionado(s)?`)) return;
            selectedChannels.forEach(selectedChannel => {
                channelsData = channelsData.filter(ch =>
                    ch.url !== selectedChannel.url || ch.name !== selectedChannel.name
                );
                favorites = favorites.filter(fav =>
                    fav.url !== selectedChannel.url || fav.name !== selectedChannel.name
                );
            });
            saveChannelsData();
            localStorage.setItem('favorites', JSON.stringify(favorites));
            const removedCount = selectedChannels.length;
            selectedChannels = [];
            currentSelectedChannel = null;
            updateChannelsDisplayByFilter();
            if (hls) { hls.destroy(); hls = null; }
            videoElement.src = '';
            platformFrame.src = '';
            channelInfo.textContent = '';
            alert(`${removedCount} canal(es) eliminado(s) correctamente.`);
        } else if (currentSelectedChannel) {
            if (!confirm('¿Seguro que deseas eliminar el canal seleccionado?')) return;
            channelsData = channelsData.filter(ch =>
                ch.url !== currentSelectedChannel.url || ch.name !== currentSelectedChannel.name
            );
            saveChannelsData();
            favorites = favorites.filter(fav =>
                fav.url !== currentSelectedChannel.url || fav.name !== currentSelectedChannel.name
            );
            currentSelectedChannel = null;
            localStorage.setItem('favorites', JSON.stringify(favorites));
            updateChannelsDisplayByFilter();
            if (hls) { hls.destroy(); hls = null; }
            videoElement.src = '';
            platformFrame.src = '';
            channelInfo.textContent = '';
            alert('Canal eliminado correctamente.');
        } else {
            alert('Selecciona al menos un canal para quitar.');
        }
    }
    function startRepSelec() {
        if (selectedChannels.length === 0) {
            alert('Selecciona al menos un canal para reproducir secuencialmente.');
            return;
        }
        repSelecIndex = 0;
        repSelecPlaying = true;
        playNextRepSelec();
    }
    function playNextRepSelec() {
        if (!repSelecPlaying || repSelecIndex >= selectedChannels.length) {
            repSelecPlaying = false;
            repSelecIndex = 0;
            return;
        }
        const channel = selectedChannels[repSelecIndex];
        playChannel(channel);
        if (videoElement.src && videoElement.src.endsWith('.mp4')) {
            videoElement.onended = () => {
                repSelecIndex++;
                playNextRepSelec();
            };
        }
    }
   function playChannel(channel) {
    if (!channel || !channel.url) return;
    currentSelectedChannel = channel;
    updateTvChannelNumber();
    const filteredChannels = getCurrentFilteredChannels();
    currentChannelIndex = filteredChannels.findIndex(
        c => c.url === channel.url
    );
    if (hls) { hls.destroy(); hls = null; }
    if (videoElement.style.display !== "none") {
        videoElement.pause();
        videoElement.src = '';
    }
    if (platformFrame.style.display !== "none") {
        platformFrame.src = '';
    }
    const urlType = getUrlType(channel.url);
    let displayName;
    if (navigationEnabled) {
        displayName = channel.name.length > 25 
            ? channel.name.substring(0, 25) + '...' 
            : channel.name;
    } else {
        displayName = channel.name.length > 40 
            ? channel.name.substring(0, 40) + '...' 
            : channel.name;
    }
    channelInfo.textContent = `${displayName} (${urlType.toUpperCase()})`;
    videoElement.style.display = 'none';
    platformFrame.style.display = 'none';
    isUsingPlatformPlayer = false;
    if (timerTimeout) {
        clearTimeout(timerTimeout);
        timerTimeout = null;
    }
    videoElement.onerror = function() {
        console.error('Error de reproducción, guardando posición...');
        connectionErrorDetected = true;
        if (videoElement.currentTime > 0) {
            savePlaybackPosition();
        }
    };
    if (hls) {
        hls.on(Hls.Events.ERROR, function(event, data) {
            if (data.fatal) {
                console.error('Error HLS, guardando posición...');
                connectionErrorDetected = true;
                if (videoElement.currentTime > 0) {
                    savePlaybackPosition();
                }
            }
        });
    }
 switch(urlType) {
    case 'hls': 
    case 'tv': playHlsStream(channel.url); break;
    case 'directo': playDirectVideo(channel.url); break;
    case 'dailymotion': playDailymotion(channel.url); break;
    case 'youtube': playYouTube(channel.url); break;
    case 'okru': playOkRu(channel.url); break;
    
        default: alert('Tipo de URL no compatible: ' + channel.url); break;
    }
    if (repSelecPlaying) {
        channelInfo.innerHTML += ' <button id="nextRepSelecBtn" style="margin-left:10px;">Siguiente</button>';
        document.getElementById('nextRepSelecBtn').onclick = () => {
            repSelecIndex++;
            playNextRepSelec();
        };
    }
    if (navigationEnabled) {
        updateCurrentFileName();
    }
    if (tvMode) {
        const filteredChannels = getCurrentFilteredChannels();
        const idx = filteredChannels.findIndex(ch => ch.url === channel.url);
        const tvChannelNumber = document.getElementById('tvChannelNumber');
        if (idx !== -1) {
            tvChannelNumber.textContent = `#${idx + 1}`;
            tvChannelNumber.style.display = 'block';
        } else {
            tvChannelNumber.style.display = 'none';
        }
    } else {
        document.getElementById('tvChannelNumber').style.display = 'none';
    }
}
    function playHlsStream(url) {
        videoElement.style.display = 'block';
        platformFrame.style.display = 'none';
        isUsingPlatformPlayer = false;
        if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
            videoElement.src = url;
            videoElement.play().catch(e => console.error("Error al reproducir:", e));
        } else if (Hls.isSupported()) {
            hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(videoElement);
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                videoElement.play().catch(e => console.error("Error al reproducir:", e));
            });
            hls.on(Hls.Events.ERROR, function(event, data) {
                console.error("HLS Error:", data);
            });
        } else {
            alert('Tu navegador no soporta la reproducción de streams HLS');
        }
    }
    function playDirectVideo(url) {
        videoElement.style.display = 'block';
        platformFrame.style.display = 'none';
        isUsingPlatformPlayer = false;
        videoElement.src = url;
        videoElement.play().catch(e => console.error("Error al reproducir:", e));
    }
    // Versión más completa con parámetros adicionales
function playDailymotion(url) {
    isUsingPlatformPlayer = true;
    platformFrame.style.display = 'block';
    videoElement.style.display = 'none';
    let videoId = '';
    
    if (url.includes('/video/')) {
        videoId = url.split('/video/')[1];
        if (videoId.includes('_')) videoId = videoId.split('_')[0];
        if (videoId.includes('?')) videoId = videoId.split('?')[0];
    }
    
    if (videoId) {
        // Parámetros que ayudan a reducir publicidad y mejorar experiencia
        platformFrame.src = `https://www.dailymotion.com/embed/video/${videoId}?` + 
            `autoplay=1&` +
            `queue-autoplay-next=0&` +       // Desactiva autoplay siguiente
            `queue-enable=0&` +              // Desactiva cola de reproducción
            `sharing-enable=0&` +            // Desactiva compartir
            `ui-logo=0&` +                   // Oculta logo
            `ui-start-screen-info=0&` +      // Oculta info inicial
            `endscreen-enable=0&` +          // Desactiva pantalla final
            `mute=0&` +                      // Sin mute por defecto
            `controls=1`;                    // Muestra controles
    } else {
        alert('No se pudo extraer el ID del video de Dailymotion');
    }
}
        function playYouTube(url) {
        isUsingPlatformPlayer = true;
        platformFrame.style.display = 'block';
        videoElement.style.display = 'none';
        let videoId = '';
        if (url.includes('v=')) {
            videoId = url.split('v=')[1];
            if (videoId.includes('&')) videoId = videoId.split('&')[0];
        } else if (url.includes('youtu.be/')) {
            videoId = url.split('youtu.be/')[1];
            if (videoId.includes('?')) videoId = videoId.split('?')[0];
        }
        if (videoId) {
            platformFrame.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
        } else {
            alert('No se pudo extraer el ID del video de YouTube');
        }
    }
    function playVimeo(url) {
        isUsingPlatformPlayer = true;
        platformFrame.style.display = 'block';
        videoElement.style.display = 'none';
        let videoId = '';
        if (url.includes('vimeo.com/')) {
            videoId = url.split('vimeo.com/')[1];
            if (videoId.includes('?')) videoId = videoId.split('?')[0];
        }
        if (videoId) {
            platformFrame.src = `https://player.vimeo.com/video/${videoId}?autoplay=1`;
        } else {
            alert('No se pudo extraer el ID del video de Vimeo');
        }
    }
    function playOkRu(url) {
        isUsingPlatformPlayer = true;
        platformFrame.style.display = 'block';
        videoElement.style.display = 'none';
        let videoId = '';
        if (url.includes('/video/')) {
            videoId = url.split('/video/')[1].split(/[/?&#]/)[0];
        } else if (url.match(/ok\.ru\/videoembed\//)) {
            videoId = url.split('/videoembed/')[1].split(/[/?&#]/)[0];
        }
        if (videoId) {
            platformFrame.src = `https://ok.ru/videoembed/${videoId}`;
        } else {
            platformFrame.src = url;
        }
    }
    function mergeChannelsAndNotify(newChannels) {
    newChannels = newChannels.filter(channel => !isInvalidChannel(channel));
    
    let repetidos = [];
    let added = 0;
    const existSet = new Set(channelsData.map(c => `${c.name.trim().toLowerCase()}|${c.url.trim()}`));
    
    newChannels.forEach(channel => {
        const clave = `${channel.name.trim().toLowerCase()}|${channel.url.trim()}`;
        if (existSet.has(clave)) {
            repetidos.push(channel.name);
        } else {
            channelsData.push(channel);
            added++;
            existSet.add(clave);
        }
    });
    
    channelsData.sort((a, b) => {
        const cleanA = a.name.replace(/^[^a-zA-Z0-9]+/, '').toLowerCase();
        const cleanB = b.name.replace(/^[^a-zA-Z0-9]+/, '').toLowerCase();
        return cleanA.localeCompare(cleanB);
    });
    
    saveChannelsData();
    updateChannelsDisplayByFilter();
    
    let mensaje = `Canales agregados: ${added}.`;
    if (repetidos.length) {
        mensaje += `\nRepetidos no añadidos (${repetidos.length}):\n- ${repetidos.slice(0,10).join('\n- ')}`;
        if (repetidos.length > 10) mensaje += `\n...y ${repetidos.length - 10} más.`;
    }
    alert(mensaje);
    isUsingDefaultList = false;
}
    function showTimerModal() {
        timerModal.style.display = 'flex';
        timerInput.value = '';
        timerInput.focus();
    }
    function hideTimerModal() {
        timerModal.style.display = 'none';
        timerInput.value = '';
    }
    function setTimer() {
        const minutes = parseInt(timerInput.value, 10);
        if (isNaN(minutes) || minutes < 1) {
            alert('Introduce un número válido de minutos');
            return;
        }
        hideTimerModal();
        if (timerTimeout) clearTimeout(timerTimeout);
        timerTimeout = setTimeout(stopPlayback, minutes * 60 * 1000);
        alert(`Temporizador activado: la reproducción se detendrá en ${minutes} minutos.`);
    }
    
    function stopPlayback() {
        if (hls) { hls.destroy(); hls = null; }
        videoElement.src = '';
        platformFrame.src = '';
        channelInfo.textContent = '';
        repSelecPlaying = false;
        repSelecIndex = 0;
        alert('¡Temporizador finalizado! La reproducción se ha detenido.');
    }
    function toggleFavorite(channel, toggleElement) {
        const index = favorites.findIndex(fav => fav.url === channel.url);
        if (index === -1) {
            favorites.push(channel);
            toggleElement.classList.add('active');
            toggleElement.textContent = '★';
        } else {
            favorites.splice(index, 1);
            toggleElement.classList.remove('active');
            toggleElement.textContent = '☆';
        }
        localStorage.setItem('favorites', JSON.stringify(favorites));
        if (currentDisplayMode === 'fav') {
            updateChannelsDisplayByFilter();
        }
        updateChannelCounter();
    }
    function displayChannels(channels) {
        channelList.innerHTML = '';
        if (!channels || channels.length === 0) {
            channelList.innerHTML = '<div class="channel-item">No hay canales para mostrar</div>';
            return;
        }
        channels.forEach(channel => {
            const isFavorite = favorites.some(fav => fav.url === channel.url);
            const isSelected = selectedChannels.some(sel => sel.url === channel.url);
            const urlType = getUrlType(channel.url);
            const channelElement = document.createElement('div');
            channelElement.className = `channel-item${isSelected ? ' selected' : ''}`;
            channelElement.innerHTML = `
                <div class="channel-name" title="${channel.name}">${channel.name}</div>
                <span class="channel-type">${urlType}</span>
                <div class="favorite-toggle ${isFavorite ? 'active' : ''}">${isFavorite ? '★' : '☆'}</div>
            `;
            let clickTimeout = null;
            channelElement.addEventListener('dblclick', function(e) {
                if (clickTimeout) {
                    clearTimeout(clickTimeout);
                    clickTimeout = null;
                }
                document.querySelectorAll('.channel-item.selected').forEach(selectedItem => {
                    selectedItem.classList.remove('selected');
                });
                channelElement.classList.add('selected');
                currentSelectedChannel = channel;
                updateSelectedChannels();
                playChannel(channel);
            });
            channelElement.querySelector('.channel-name').addEventListener('click', function(e) {
                e.stopPropagation();
                if (channelElement.classList.contains('selected')) {
                    channelElement.classList.remove('selected');
                } else {
                    channelElement.classList.add('selected');
                }
                updateSelectedChannels();
            });
            channelElement.querySelector('.channel-name').addEventListener('dblclick', function(e) {
                e.stopPropagation();
                if (clickTimeout) {
                    clearTimeout(clickTimeout);
                    clickTimeout = null;
                }
                document.querySelectorAll('.channel-item.selected').forEach(selectedItem => {
                    selectedItem.classList.remove('selected');
                });
                channelElement.classList.add('selected');
                currentSelectedChannel = channel;
                updateSelectedChannels();
                playChannel(channel);
            });
            const favoriteToggle = channelElement.querySelector('.favorite-toggle');
            favoriteToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(channel, favoriteToggle);
            });
            channelList.appendChild(channelElement);
        });
    }
    function updateChannelCounter() {
        let count = getCurrentFilteredChannels().length;
        channelCounter.textContent = `Canales: ${count}`;
    }
    function loadDefaultList() {
        fetch(DEFAULT_LIST_URL)
            .then(response => {
                if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
                return response.text();
            })
            .then(content => {
                channelsData = parseChannelData(content);
                isUsingDefaultList = true;
                updateChannelsDisplayByFilter();
                currentDisplayMode = 'all';
            })
            .catch(error => {
                channelList.innerHTML = `<div class="channel-item">Error cargando la lista por defecto: ${error.message}</div>`;
                updateChannelCounter();
                isUsingDefaultList = false;
            });
    }
    function parseChannelData(data, fileName = '') {
    let jsonChannels = [];
    try {
        if (
            fileName.endsWith('.json') ||
            fileName.endsWith('.JSON') ||
            data.trim().startsWith('{') ||
            data.trim().startsWith('[')
        ) {
            const parsed = JSON.parse(data);
            if (Array.isArray(parsed)) {
                jsonChannels = parsed.map(ch => ({
                    name: ch.name || ch.title || `Canal ${jsonChannels.length + 1}`,
                    url: ch.url || ch.stream || '',
                    group: ch.group || ch.category || '',
                    logo: ch.logo || ''
                })).filter(ch => ch.url);
            } else if (parsed.channels && Array.isArray(parsed.channels)) {
                jsonChannels = parsed.channels.map(ch => ({
                    name: ch.name || ch.title || `Canal ${jsonChannels.length + 1}`,
                    url: ch.url || ch.stream || '',
                    group: ch.group || ch.category || '',
                    logo: ch.logo || ''
                })).filter(ch => ch.url);
            }
            if (jsonChannels.length > 0) {
                const filteredChannels = jsonChannels.filter(channel => !isInvalidChannel(channel));
                filteredChannels.sort((a, b) => {
                    const cleanA = a.name.replace(/^[^a-zA-Z0-9]+/, '').toLowerCase();
                    const cleanB = b.name.replace(/^[^a-zA-Z0-9]+/, '').toLowerCase();
                    return cleanA.localeCompare(cleanB);
                });
                return filteredChannels;
            }
        }
    } catch (e) {}
    
    const lines = data.split('\n');
    const channels = [];
    let currentGroup = '';
    let currentLogo = '';
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        if (line.startsWith('#EXTGRP:')) {
            currentGroup = line.replace('#EXTGRP:', '').trim();
            continue;
        }
        
        if (line.startsWith('#EXTINF:')) {
            const commaIndex = line.indexOf(',');
            let channelName = commaIndex !== -1 ? line.slice(commaIndex + 1) : `Canal ${channels.length + 1}`;
            const paramsPart = commaIndex !== -1 ? line.slice(0, commaIndex) : line;
            
            const tvgNameMatch = paramsPart.match(/tvg-name="([^"]*)"/);
            if (tvgNameMatch && tvgNameMatch[1]) {
                channelName = tvgNameMatch[1];
            }
            
            const groupMatch = paramsPart.match(/group-title="([^"]*)"/);
            if (groupMatch && groupMatch[1]) {
                currentGroup = groupMatch[1];
            }
            
            const logoMatch = paramsPart.match(/tvg-logo="([^"]*)"/);
            currentLogo = logoMatch && logoMatch[1] ? logoMatch[1] : '';
            
            if (i + 1 < lines.length) {
                const urlLine = lines[i + 1].trim();
                if (urlLine && !urlLine.startsWith('#')) {
                    channels.push({
                        name: channelName,
                        url: urlLine,
                        group: currentGroup || '',
                        logo: currentLogo
                    });
                    i++;
                }
            }
        }
        else if (line.startsWith('http')) {
            channels.push({
                name: `Canal ${channels.length + 1}`,
                url: line,
                group: currentGroup || '',
                logo: currentLogo
            });
        }
    }
    
    const filteredChannels = channels.filter(channel => !isInvalidChannel(channel));
    filteredChannels.sort((a, b) => {
        const cleanA = a.name.replace(/^[^a-zA-Z0-9]+/, '').toLowerCase();
        const cleanB = b.name.replace(/^[^a-zA-Z0-9]+/, '').toLowerCase();
        return cleanA.localeCompare(cleanB);
    });
    
    return filteredChannels;
}
    function cleanupInvalidChannels() {
    const initialCount = channelsData.length;
    channelsData = channelsData.filter(channel => !isInvalidChannel(channel));
    const removedCount = initialCount - channelsData.length;
    
    // También limpiar favoritos
    const initialFavCount = favorites.length;
    favorites = favorites.filter(channel => !isInvalidChannel(channel));
    const removedFavCount = initialFavCount - favorites.length;
    
    // Limpiar selectedChannels si existen
    const initialSelCount = selectedChannels.length;
    selectedChannels = selectedChannels.filter(channel => !isInvalidChannel(channel));
    const removedSelCount = initialSelCount - selectedChannels.length;
    
    // Limpiar currentSelectedChannel si es inválido
    if (currentSelectedChannel && isInvalidChannel(currentSelectedChannel)) {
        currentSelectedChannel = null;
        // Detener reproducción actual
        if (hls) { hls.destroy(); hls = null; }
        videoElement.src = '';
        platformFrame.src = '';
        channelInfo.textContent = '';
    }
    
    // Guardar cambios
    saveChannelsData();
    localStorage.setItem('favorites', JSON.stringify(favorites));
    
    // Actualizar interfaz
    updateChannelsDisplayByFilter();
    
    // Mostrar mensaje
    alert(`Se eliminaron ${removedCount} canales inválidos, ${removedFavCount} favoritos inválidos y ${removedSelCount} seleccionados inválidos.`);
    
    // Actualizar contador
    updateChannelCounter();
}
function filterInvalidChannels(channels) {
    return channels.filter(channel => !isInvalidChannel(channel));
}
    function toggleNavigation() {
    if (!navigationEnabled && getCurrentFilteredChannels().length === 0) {
        alert('Carga una lista de canales primero');
        return;
    }
    navigationEnabled = !navigationEnabled;
    if (navigationEnabled) {
        const filteredChannels = getCurrentFilteredChannels();
        if (currentSelectedChannel) {
            currentChannelIndex = filteredChannels.findIndex(
                ch => ch.url === currentSelectedChannel.url && ch.name === currentSelectedChannel.name
            );
        } else if (filteredChannels.length > 0) {
            currentChannelIndex = 0;
            currentSelectedChannel = filteredChannels[0];
        }
        toggleNavBtn.textContent = 'ON';
        toggleNavBtn.classList.remove('off');
        toggleNavBtn.classList.add('on');
        if (currentSelectedChannel) {
            playChannel(currentSelectedChannel);
        }
        updateTvChannelNumber();
    } else {
        toggleNavBtn.textContent = 'OFF';
        toggleNavBtn.classList.remove('on');
        toggleNavBtn.classList.add('off');
        document.getElementById('tvChannelNumber').style.display = 'none';
        
        // AÑADIR ESTAS LÍNEAS: Forzar modo TV cuando se desactiva la navegación
        if (!tvMode) {
            setMode(true); // Activar modo TV
        }
    }
    toggleInterface();
}
    function playNextChannel() {
    updateTvChannelNumber(); // ← Añadir esta línea
    const filteredChannels = getCurrentFilteredChannels();
    if (filteredChannels.length === 0) return;
    if (currentChannelIndex >= filteredChannels.length - 1) {
        currentChannelIndex = 0;
    } else {
        currentChannelIndex++;
    }
    currentSelectedChannel = filteredChannels[currentChannelIndex];
    playChannel(currentSelectedChannel);
    updateCurrentFileName();
}

function playPreviousChannel() {
    updateTvChannelNumber(); // ← Añadir esta línea
    const filteredChannels = getCurrentFilteredChannels();
    if (filteredChannels.length === 0) return;
    if (currentChannelIndex <= 0) {
        currentChannelIndex = filteredChannels.length - 1;
    } else {
        currentChannelIndex--;
    }
    currentSelectedChannel = filteredChannels[currentChannelIndex];
    playChannel(currentSelectedChannel);
    updateCurrentFileName();
}
    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            const newChannels = parseChannelData(content, file.name);
            mergeChannelsAndNotify(newChannels);
        };
        reader.readAsText(file);
    }
    function downloadFromUrl() {
        const url = urlInput.value.trim();
        if (!url) {
            alert('Por favor introduce una URL válida');
            return;
        }
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
                return response.text();
            })
            .then(content => {
                const ext = url.toLowerCase().split('.').pop();
                const newChannels = parseChannelData(content, url);
                mergeChannelsAndNotify(newChannels);
                hideUrlModal();
            })
            .catch(error => {
                alert('Error al descargar la lista: ' + error.message);
                console.error(error);
            });
    }
    function getUrlType(url) {
    if (!url) return 'unknown';
    if (url.includes('.m3u8')) return 'tv';
    if (url.includes('.m3u')) return 'tv';
    if (url.includes('.mp4') || url.includes('.webm') || url.includes('.ogg')) return 'directo';
    if (url.match(/dailymotion\.com/)) return 'dailymotion';
    if (url.match(/youtube\.com|youtu\.be/)) return 'youtube';
    if (url.match(/ok\.ru/)) return 'okru';
    
    return 'unknown';
}
function initPlatformFilters() {
    const platformFilterContainer = document.querySelector('.platform-filter-container');
    platformFilterContainer.innerHTML = `
        <div class="platform-filters">
            <label>Filtrar plataformas:</label>
            <div class="platform-checkboxes">
                <label><input type="checkbox" name="platform" value="all" checked> Todas</label>
                <label><input type="checkbox" name="platform" value="YouTube" checked> YouTube</label>
                <label><input type="checkbox" name="platform" value="Dailymotion" checked> Dailymotion</label>
                <label><input type="checkbox" name="platform" value="okru" checked> ok.ru</label>
                <label><input type="checkbox" name="platform" value="TV" checked> TV</label>



            </div>
        </div>
    `;

    const allCheckbox = platformFilterContainer.querySelector('input[value="all"]');
    const otherCheckboxes = platformFilterContainer.querySelectorAll('input[name="platform"]:not([value="all"])');
    
    allCheckbox.addEventListener('change', function() {
        if (this.checked) {
            otherCheckboxes.forEach(checkbox => checkbox.checked = true);
        }
        updateChannelsDisplayByFilter();
    });
    
    otherCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (!this.checked) {
                allCheckbox.checked = false;
            }
            const allChecked = Array.from(otherCheckboxes).every(cb => cb.checked);
            if (allChecked) {
                allCheckbox.checked = true;
            }
            updateChannelsDisplayByFilter();
        });
    });
}

function getSelectedPlatforms() {
    const selectedPlatforms = [];
    const checkboxes = document.querySelectorAll('.platform-checkboxes input[name="platform"]:checked');
    
    // Si "all" está seleccionado, retornar todas las plataformas
    const allChecked = Array.from(checkboxes).some(checkbox => checkbox.value === 'all');
    if (allChecked) {
        return ['youtube', 'dailymotion', 'okru', 'tv', 'directo'];
    }
    
    // Mapear los valores de los checkboxes a los valores que retorna getUrlType()
    checkboxes.forEach(checkbox => {
        switch(checkbox.value) {
            case 'YouTube': selectedPlatforms.push('youtube'); break;
            case 'Dailymotion': selectedPlatforms.push('dailymotion'); break;
            case 'okru': selectedPlatforms.push('okru'); break;
            case 'TV': selectedPlatforms.push('tv'); break;
            default: selectedPlatforms.push(checkbox.value);
        }
    });
    
    return selectedPlatforms;
}

function getCurrentFilteredChannels() {
    let list = [...channelsData];
    
    const selectedPlatforms = getSelectedPlatforms();
    if (selectedPlatforms.length > 0 && !selectedPlatforms.includes('all')) {
        list = list.filter(ch => {
            const platform = getUrlType(ch.url);
            return selectedPlatforms.includes(platform);
        });
    }
    
    if (currentDisplayMode === 'search' && currentSearchTerm !== '') {
        list = list.filter(channel =>
            channel.name.toLowerCase().includes(currentSearchTerm)
        );
    } else if(currentDisplayMode === 'fav') {
        let filteredFavs = [...favorites];
        const selectedPlatforms = getSelectedPlatforms();
        if (selectedPlatforms.length > 0 && !selectedPlatforms.includes('all')) {
            filteredFavs = filteredFavs.filter(ch => {
                const platform = getUrlType(ch.url);
                return selectedPlatforms.includes(platform);
            });
        }
        list = filteredFavs;
    }
    return list;
}

function updateChannelsDisplayByFilter() {
    if(currentDisplayMode === 'fav') {
        displayChannels(getCurrentFilteredChannels());
    } else if(currentDisplayMode === 'search') {
        handleSearchInput();
    } else {
        displayChannels(getCurrentFilteredChannels());
    }
    updateChannelCounter();
}

function initEvents() {
    document.getElementById('toggleListBtn').addEventListener('click', toggleChannelList);
    toggleNavBtn.addEventListener('click', function() {
        if (getCurrentFilteredChannels().length === 0 && !navigationEnabled) {
            alert('Carga una lista de canales primero');
            return;
        }
        toggleNavigation();
    });
    document.getElementById('cleanupButton').addEventListener('click', cleanupInvalidChannels);
    prevBtn.addEventListener('click', playPreviousChannel);
    nextBtn.addEventListener('click', playNextChannel);
    document.getElementById('repSelecButton').addEventListener('click', startRepSelec);
    timerButton.addEventListener('click', showTimerModal);
    setTimerButton.addEventListener('click', setTimer);
    cancelTimerButton.addEventListener('click', hideTimerModal);
    loadButton.addEventListener('click', () => fileInput.click());
    saveButton.addEventListener('click', saveSelectedChannels);
    favButton.addEventListener('click', showFavorites);
    allButton.addEventListener('click', showAllChannels);
    searchButton.addEventListener('click', toggleSearch);
    urlButton.addEventListener('click', showUrlModal);
    addButton.addEventListener('click', showAddChannelModal);
    editButton.addEventListener('click', showEditChannelModal);
    removeButton.addEventListener('click', removeSelectedChannel);
    selectAllButton.addEventListener('click', selectAllChannels);
    deselectAllButton.addEventListener('click', deselectAllChannels);
    fileInput.addEventListener('change', handleFileSelect);
    downloadButton.addEventListener('click', downloadFromUrl);
    cancelButton.addEventListener('click', hideUrlModal);
    searchInput.addEventListener('input', handleSearchInput);
    addChannelButton.addEventListener('click', addOrEditChannel);
    cancelAddChannelButton.addEventListener('click', hideAddChannelModal);
    moreButton.addEventListener('click', toggleSecondaryButtons);
    tvModeButton.addEventListener('click', handleTvModeSwitch);
    tvModeButtonAndroid.addEventListener('click', handleTvModeSwitch);
    fullscreenBtn.addEventListener('click', enterFullscreen);
    fullscreenBtnAndroid.addEventListener('click', enterFullscreen);
    scrollUpBtn.addEventListener('click', () => scrollChannelList('up'));
    scrollDownBtn.addEventListener('click', () => scrollChannelList('down'));
    playBtnTv.addEventListener('click', playSelectedChannelFromTV);
    
    document.getElementById('resumeButton').addEventListener('click', resumePlayback);
    
    initPlatformFilters();
}

function initApp() {
    initEvents();
    if (loadChannelsData()) {
        updateChannelsDisplayByFilter();
        currentDisplayMode = 'all';
        isUsingDefaultList = false;
    } else {
        loadDefaultList();
    }
    
    setMode(false);
}
    
    // Inicializar la aplicación cuando el DOM esté listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
} else {
    initApp();
}
    
    
    </script>
</body>
</html>
