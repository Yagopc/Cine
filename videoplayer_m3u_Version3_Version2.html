<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reproductor M3U de Vídeos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0; padding: 0;
            background: #181818; color: #f5f5f5;
        }
        header {
            background: #24292f;
            padding: 1em;
            text-align: center;
            font-size: 1.2em;
            color: #fff;
        }
        #controls {
            margin: 1em auto 0 auto;
            width: 95%;
            max-width: 800px;
            display: flex;
            gap: 1em;
            justify-content: center;
            flex-wrap: wrap;
        }
        #fileInput {
            display: none;
        }
        #fileLabel, #clearBtn, #analyzeBtn, #saveOnlineBtn, #removeOfflineBtn, #updateBtn {
            display: block;
            background: #0366d6;
            color: #fff;
            padding: 0.7em 1.5em;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            text-align: center;
            transition: background 0.3s;
        }
        #fileLabel:hover, #analyzeBtn:hover, #saveOnlineBtn:hover, #removeOfflineBtn:hover, #updateBtn:hover {
            background: #0356b6;
        }
        #clearBtn {
            background: #e53935;
        }
        #clearBtn:hover {
            background: #b71c1c;
        }
        #saveOnlineBtn {
            background: #1abc9c;
        }
        #removeOfflineBtn {
            background: #f39c12;
        }
        #removeOfflineBtn:hover {
            background: #bc860c;
        }
        #updateBtn {
            background: #9b59b6;
        }
        #updateBtn:hover {
            background: #7c379a;
        }
        #playlist {
            margin: 1em auto;
            width: 95%;
            max-width: 800px;
            background: #222;
            border-radius: 8px;
            padding: 0.5em 0;
            box-shadow: 0 0 6px #0005;
        }
        .video-item {
            padding: 1em;
            border-bottom: 1px solid #333;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .video-item:last-child {
            border-bottom: none;
        }
        .video-main {
            display: flex;
            align-items: center;
            flex: 1;
            cursor: pointer;
            gap: 0.7em;
        }
        .video-item:hover {
            background: #2a2a2a;
        }
        .status {
            font-size: 0.95em;
            font-weight: bold;
        }
        .online {
            color: #34c759;
        }
        .offline {
            color: #ff3b30;
        }
        .delete-btn {
            background: none;
            border: none;
            color: #e53935;
            font-size: 1.3em;
            cursor: pointer;
            margin-left: 0.5em;
            padding: 0 0.2em;
            transition: color 0.2s;
        }
        .delete-btn:hover {
            color: #b71c1c;
        }
        #videoModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.92);
            align-items: center;
            justify-content: center;
        }
        #videoContainer {
            background: #000;
            border-radius: 10px;
            padding: 1em;
            max-width: 96vw;
            max-height: 85vh;
            box-sizing: border-box;
            position: relative;
        }
        #videoTitle {
            font-size: 1em;
            margin-bottom: 0.5em;
            color: #fff;
            text-align: center;
        }
        #videoPlayer {
            width: 100%;
            max-width: 90vw;
            max-height: 60vw;
            background: #111;
            border-radius: 8px;
            display: block;
        }
        #youtubeIframe {
            width: 100%;
            max-width: 90vw;
            height: 56vw;
            max-height: 60vw;
            background: #111;
            border-radius: 8px;
            display: none;
        }
        #closeBtn {
            position: absolute;
            top: 0.5em; right: 0.5em;
            background: #e53935;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 2em; height: 2em;
            font-size: 1.3em;
            cursor: pointer;
            transition: background 0.2s;
        }
        #closeBtn:hover {
            background: #b71c1c;
        }
        #castBtn {
            position: absolute;
            top: 0.5em; left: 0.5em;
            background: #4285f4;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 2em; height: 2em;
            font-size: 1.3em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
            transition: background 0.2s;
        }
        #castBtn:hover {
            background: #1a73e8;
        }
        #castBtn svg {
            width: 1.2em;
            height: 1.2em;
            fill: #fff;
        }
        @media (max-width: 600px) {
            #videoContainer {
                padding: 0.5em;
            }
            .video-item {
                padding: 0.7em;
                font-size: 1em;
            }
            #controls {
                flex-direction: column;
            }
        }
    </style>
    <!-- Google Cast Sender SDK -->
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
</head>
<body>
    <header>
        Reproductor de Vídeos M3U
    </header>
    <div id="controls">
        <label id="fileLabel" for="fileInput">Selecciona tu archivo M3U (.m3u o .txt)</label>
        <button id="updateBtn" type="button">Actualizar lista</button>
        <button id="analyzeBtn" type="button">Analizar lista</button>
        <button id="saveOnlineBtn" type="button">Guardar online (.m3u)</button>
        <button id="removeOfflineBtn" type="button">Eliminar offline</button>
        <button id="clearBtn" type="button">Limpiar</button>
    </div>
    <input type="file" id="fileInput" accept=".m3u,.txt"/>
    <div id="playlist"></div>

    <div id="videoModal">
        <div id="videoContainer">
            <button id="castBtn" title="Enviar a Chromecast" style="display:none;">
                <svg viewBox="0 0 24 24"><path d="M1,18 L3,18 C3,19.1 3.9,20 5,20 L5,22 C2.8,22 1,20.2 1,18 Z M1,14 L5,14 C5,16.2 6.8,18 9,18 L9,20 C5.1,20 1,15.9 1,14 Z M1,10 L9,10 C9,13.9 12.1,17 16,17 L16,19 C10.5,19 5,13.5 5,8 L1,8 Z M21,3 L3,3 C1.9,3 1,3.9 1,5 L1,7 L3,7 L3,5 L21,5 L21,19 L15,19 L15,21 L21,21 C22.1,21 23,20.1 23,19 L23,5 C23,3.9 22.1,3 21,3 Z"/></svg>
            </button>
            <button id="closeBtn" title="Cerrar">&times;</button>
            <div id="videoTitle"></div>
            <video id="videoPlayer" controls autoplay playsinline></video>
            <iframe id="youtubeIframe" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        </div>
    </div>

    <script>
        // Referencias de elementos
        const fileInput = document.getElementById('fileInput');
        const fileLabel = document.getElementById('fileLabel');
        const playlistDiv = document.getElementById('playlist');
        const videoModal = document.getElementById('videoModal');
        const videoPlayer = document.getElementById('videoPlayer');
        const youtubeIframe = document.getElementById('youtubeIframe');
        const videoTitleDiv = document.getElementById('videoTitle');
        const closeBtn = document.getElementById('closeBtn');
        const castBtn = document.getElementById('castBtn');
        const clearBtn = document.getElementById('clearBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const saveOnlineBtn = document.getElementById('saveOnlineBtn');
        const removeOfflineBtn = document.getElementById('removeOfflineBtn');
        const updateBtn = document.getElementById('updateBtn');

        const STORAGE_KEY = 'm3u_video_list_v2';
        let videos = [];
        let currentVideoIdx = null;

        // Cargar lista de localStorage al inicio
        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try { videos = JSON.parse(saved); } catch { videos = []; }
            }
            showPlaylist(videos);
        });
        function saveList() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(videos));
        }

        // Chromecast
        let castInitialized = false;
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                cast.framework.CastContext.getInstance().setOptions({
                    receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });
                castInitialized = true;
            }
        };
        function toggleCastBtn(show) {
            castBtn.style.display = show ? 'flex' : 'none';
        }

        async function castCurrentVideo() {
            if (!castInitialized) {
                alert('Chromecast no está disponible en este navegador o aún no se ha cargado el framework.');
                return;
            }
            const video = videos[currentVideoIdx];
            if (!video) return;

            const castContext = cast.framework.CastContext.getInstance();

            // Si es YouTube, lanza usando la app oficial de YouTube
            if (isYouTubeUrl(video.url)) {
                cast.framework.CastContext.getInstance().setOptions({
                    receiverApplicationId: 'YouTube', // 'YouTube' app id
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });
                const ytId = getYouTubeId(video.url);
                if (!ytId) {
                    alert('No se pudo extraer el ID del vídeo de YouTube.');
                    return;
                }
                castContext.requestSession().then(function() {
                    const session = castContext.getCurrentSession();
                    if (session) {
                        session.sendMessage('urn:x-cast:com.google.youtube', {
                            'type': 'flingVideo',
                            'videoId': ytId
                        });
                    }
                });
            } else {
                cast.framework.CastContext.getInstance().setOptions({
                    receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });
                const session = castContext.getCurrentSession();
                if (!session) {
                    castContext.requestSession().then(() => {
                        setTimeout(() => castCurrentVideo(), 500);
                    }).catch((e) => {
                        alert('No se pudo iniciar la sesión de Chromecast: ' + e);
                    });
                    return;
                }
                const mediaInfo = new chrome.cast.media.MediaInfo(video.url, 'video/mp4');
                mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
                mediaInfo.metadata.title = video.title || 'Vídeo M3U';
                const request = new chrome.cast.media.LoadRequest(mediaInfo);
                session.loadMedia(request).then(
                    function() {},
                    function(errorCode) {
                        alert('Error enviando vídeo a Chromecast: ' + errorCode);
                    }
                );
            }
        }
        castBtn.addEventListener('click', castCurrentVideo);

        // Devuelve solo las URLs únicas
        function dedupeAndMergeVideos(oldList, newList) {
            const urlSet = new Set(oldList.map(v => v.url));
            const deduped = [...oldList];
            for (const v of newList) {
                if (!urlSet.has(v.url)) {
                    deduped.push(v);
                    urlSet.add(v.url);
                }
            }
            return deduped;
        }
        // Parsear el archivo M3U y devolver [{title, url, status}]
        function parseM3U(content) {
            const lines = content.split(/\r?\n/);
            const entries = [];
            let currentTitle = '';
            for (let line of lines) {
                line = line.trim();
                if (line.startsWith('#EXTINF:')) {
                    const parts = line.split(',');
                    currentTitle = parts.length > 1 ? parts[1].trim() : '';
                } else if (line && !line.startsWith('#')) {
                    if (currentTitle) {
                        entries.push({ title: currentTitle, url: line, status: null });
                        currentTitle = '';
                    }
                }
            }
            return entries;
        }

        // ---------------------------
        // NUEVO: Cargar desde JSON externo
        // ---------------------------
        updateBtn.addEventListener('click', async function() {
            updateBtn.disabled = true;
            updateBtn.textContent = "Actualizando...";
            try {
                const response = await fetch("https://yagopc.github.io/Cine/YouTuberomanos.json");
                if (!response.ok) throw new Error("No se pudo descargar el archivo remoto");
                const data = await response.json();
                // Espera que data sea un array de objetos con title y url (y opcionalmente status)
                if (!Array.isArray(data)) throw new Error("El archivo remoto no contiene un array");
                // Normaliza los campos, por si acaso
                const newList = data.map(item => ({
                    title: item.title || item.nombre || item.name || "",
                    url: item.url || "",
                    status: null
                })).filter(v => v.title && v.url);
                if (newList.length === 0) throw new Error("No se encontraron vídeos válidos en el archivo remoto");
                videos = newList;
                saveList();
                showPlaylist(videos);
                alert("Lista actualizada correctamente desde el archivo remoto.");
            } catch (e) {
                alert("Error actualizando la lista: " + e.message);
            }
            updateBtn.disabled = false;
            updateBtn.textContent = "Actualizar lista";
        });

        function showPlaylist(videos) {
            playlistDiv.innerHTML = '';
            if (videos.length === 0) {
                playlistDiv.innerHTML = '<div style="padding:1em;text-align:center;color:#aaa;">No se encontraron vídeos en el archivo.</div>';
                return;
            }
            videos.forEach((video, idx) => {
                const div = document.createElement('div');
                div.className = 'video-item';

                // Botón de eliminar
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.title = 'Eliminar de la lista';
                deleteBtn.innerHTML = '🗑️';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteVideo(idx);
                };

                // Bloque principal clicable (título + estado)
                const mainDiv = document.createElement('div');
                mainDiv.className = 'video-main';
                mainDiv.onclick = () => playVideo(idx);

                // Título
                const spanTitle = document.createElement('span');
                spanTitle.textContent = video.title;

                // Estado online/offline
                let statusSpan = '';
                if (video.status === 'online') {
                    statusSpan = document.createElement('span');
                    statusSpan.className = 'status online';
                    statusSpan.textContent = 'Online';
                } else if (video.status === 'offline') {
                    statusSpan = document.createElement('span');
                    statusSpan.className = 'status offline';
                    statusSpan.textContent = 'Offline';
                }

                mainDiv.appendChild(spanTitle);
                if (statusSpan) mainDiv.appendChild(statusSpan);

                div.appendChild(mainDiv);
                div.appendChild(deleteBtn);

                playlistDiv.appendChild(div);
            });
        }

        function deleteVideo(idx) {
            videos.splice(idx, 1);
            saveList();
            showPlaylist(videos);
        }

        function isYouTubeUrl(url) {
            return /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\//.test(url);
        }
        function getYouTubeId(url) {
            // Extrae el ID de YouTube de varias formas
            let m = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?(?:.*&)?v=|embed\/|live\/|shorts\/))([a-zA-Z0-9_-]{11})/);
            if (m) return m[1];
            m = url.match(/youtube\.com\/live\/([a-zA-Z0-9_-]{11})/);
            if (m) return m[1];
            m = url.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
            if (m) return m[1];
            return null;
        }
        function getYouTubeEmbedUrl(url) {
            // Genera el embed URL de YouTube o live
            const videoId = getYouTubeId(url);
            if (videoId) {
                return "https://www.youtube.com/embed/" + videoId + "?autoplay=1";
            }
            return url;
        }

        function playVideo(idx) {
            const video = videos[idx];
            currentVideoIdx = idx;

            if (isYouTubeUrl(video.url)) {
                videoPlayer.pause();
                videoPlayer.src = '';
                videoPlayer.style.display = 'none';
                youtubeIframe.style.display = 'block';
                youtubeIframe.src = getYouTubeEmbedUrl(video.url);
            } else {
                videoPlayer.src = video.url;
                videoPlayer.style.display = 'block';
                youtubeIframe.style.display = 'none';
                youtubeIframe.src = '';
                setTimeout(() => videoPlayer.play(), 100);
            }

            videoTitleDiv.textContent = video.title;
            videoModal.style.display = 'flex';
            toggleCastBtn(castInitialized && !!video.url);
        }
        function closeModal() {
            videoPlayer.pause();
            videoPlayer.src = '';
            videoPlayer.style.display = 'block';
            youtubeIframe.src = '';
            youtubeIframe.style.display = 'none';
            videoModal.style.display = 'none';
            toggleCastBtn(false);
        }

        // Manejo de archivo seleccionado
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const newList = parseM3U(evt.target.result);
                videos = dedupeAndMergeVideos(videos, newList);
                saveList();
                showPlaylist(videos);
                fileInput.value = "";
            };
            reader.readAsText(file, 'utf-8');
        });

        // Limpiar lista
        clearBtn.addEventListener('click', function() {
            videos = [];
            saveList();
            showPlaylist(videos);
        });

        // Analizar estado online/offline de cada vídeo usando <video>
        analyzeBtn.addEventListener('click', function() {
            if (videos.length === 0) return;
            let changed = false;
            let idx = 0;
            function checkNext() {
                if (idx >= videos.length) {
                    if (changed) saveList();
                    showPlaylist(videos);
                    return;
                }
                const v = videos[idx];
                // Solo testear archivos directos, no YouTube
                if (isYouTubeUrl(v.url)) {
                    v.status = null;
                    idx++;
                    setTimeout(checkNext, 100);
                    return;
                }
                const testVideo = document.createElement('video');
                testVideo.style.display = 'none';
                testVideo.preload = 'metadata';
                testVideo.src = v.url;
                document.body.appendChild(testVideo);
                let finished = false;
                let timeout = setTimeout(() => {
                    if (!finished) {
                        finished = true;
                        v.status = 'offline';
                        changed = true;
                        document.body.removeChild(testVideo);
                        showPlaylist(videos);
                        idx++;
                        setTimeout(checkNext, 100);
                    }
                }, 8000);

                testVideo.addEventListener('canplay', () => {
                    if (!finished) {
                        finished = true;
                        v.status = 'online';
                        changed = true;
                        clearTimeout(timeout);
                        document.body.removeChild(testVideo);
                        showPlaylist(videos);
                        idx++;
                        setTimeout(checkNext, 100);
                    }
                });
                testVideo.addEventListener('error', () => {
                    if (!finished) {
                        finished = true;
                        v.status = 'offline';
                        changed = true;
                        clearTimeout(timeout);
                        document.body.removeChild(testVideo);
                        showPlaylist(videos);
                        idx++;
                        setTimeout(checkNext, 100);
                    }
                });
                try { testVideo.load(); } catch {}
            }
            checkNext();
        });

        // Eliminar todos los archivos offline
        removeOfflineBtn.addEventListener('click', function() {
            const onlineVideos = videos.filter(v => v.status === 'online' || v.status === null);
            if (onlineVideos.length === videos.length) {
                alert('No hay archivos offline para eliminar.');
                return;
            }
            videos = onlineVideos;
            saveList();
            showPlaylist(videos);
        });

        // Guardar solo los online en formato M3U
        saveOnlineBtn.addEventListener('click', function() {
            const items = videos.filter(v => v.status === 'online' || v.status === null);
            if (!items.length) {
                alert('No hay archivos online para guardar.');
                return;
            }
            let m3u = '#EXTM3U\n';
            items.forEach(v => {
                m3u += `#EXTINF:-1,${v.title}\n${v.url}\n`;
            });
            const blob = new Blob([m3u], { type: 'audio/x-mpegurl' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'online.m3u';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                URL.revokeObjectURL(a.href);
                document.body.removeChild(a);
            }, 500);
        });

        // Delegar click en el label al input
        fileLabel.addEventListener('click', function() {
            fileInput.click();
        });
        closeBtn.addEventListener('click', closeModal);
        videoModal.addEventListener('click', function(e) {
            if (e.target === videoModal) closeModal();
        });
        videoModal.addEventListener('touchstart', function() {
            if (videoPlayer.paused) videoPlayer.play();
        }, { once: true });
        showPlaylist(videos);
    </script>
</body>
</html>