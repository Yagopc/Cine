<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reproductor M3U de Vídeos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0; padding: 0;
            background: #181818; color: #f5f5f5;
        }
        header {
            background: #24292f;
            padding: 1em;
            text-align: center;
            font-size: 1.2em;
            color: #fff;
        }
        #controls {
            margin: 1em auto 0 auto;
            width: 95%;
            max-width: 800px;
            display: flex;
            gap: 1em;
            justify-content: center;
            flex-wrap: wrap;
        }
        #fileInput {
            display: none;
        }
        #fileLabel, #clearBtn, #analyzeBtn, #saveOnlineBtn {
            display: block;
            background: #0366d6;
            color: #fff;
            padding: 0.7em 1.5em;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            text-align: center;
            transition: background 0.3s;
        }
        #fileLabel:hover, #analyzeBtn:hover, #saveOnlineBtn:hover {
            background: #0356b6;
        }
        #clearBtn {
            background: #e53935;
        }
        #clearBtn:hover {
            background: #b71c1c;
        }
        #saveOnlineBtn {
            background: #1abc9c;
        }
        #playlist {
            margin: 1em auto;
            width: 95%;
            max-width: 800px;
            background: #222;
            border-radius: 8px;
            padding: 0.5em 0;
            box-shadow: 0 0 6px #0005;
        }
        .video-item {
            padding: 1em;
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: background 0.2s;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .video-item:last-child {
            border-bottom: none;
        }
        .video-item:hover {
            background: #2a2a2a;
        }
        .status {
            font-size: 0.95em;
            font-weight: bold;
        }
        .online {
            color: #34c759;
        }
        .offline {
            color: #ff3b30;
        }
        #videoModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.92);
            align-items: center;
            justify-content: center;
        }
        #videoContainer {
            background: #000;
            border-radius: 10px;
            padding: 1em;
            max-width: 96vw;
            max-height: 85vh;
            box-sizing: border-box;
            position: relative;
        }
        #videoTitle {
            font-size: 1em;
            margin-bottom: 0.5em;
            color: #fff;
            text-align: center;
        }
        #videoPlayer {
            width: 100%;
            max-width: 90vw;
            max-height: 60vw;
            background: #111;
            border-radius: 8px;
        }
        #closeBtn {
            position: absolute;
            top: 0.5em; right: 0.5em;
            background: #e53935;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 2em; height: 2em;
            font-size: 1.3em;
            cursor: pointer;
            transition: background 0.2s;
        }
        #closeBtn:hover {
            background: #b71c1c;
        }
        #castBtn {
            position: absolute;
            top: 0.5em; left: 0.5em;
            background: #4285f4;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 2em; height: 2em;
            font-size: 1.3em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
            transition: background 0.2s;
        }
        #castBtn:hover {
            background: #1a73e8;
        }
        #castBtn svg {
            width: 1.2em;
            height: 1.2em;
            fill: #fff;
        }
        @media (max-width: 600px) {
            #videoContainer {
                padding: 0.5em;
            }
            .video-item {
                padding: 0.7em;
                font-size: 1em;
            }
            #controls {
                flex-direction: column;
            }
        }
    </style>
    <!-- Google Cast Sender SDK -->
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
</head>
<body>
    <header>
        Reproductor de Vídeos M3U
    </header>
    <div id="controls">
        <label id="fileLabel" for="fileInput">Selecciona tu archivo M3U (.m3u o .txt)</label>
        <button id="analyzeBtn" type="button">Analizar lista</button>
        <button id="saveOnlineBtn" type="button">Guardar online (.m3u)</button>
        <button id="clearBtn" type="button">Limpiar</button>
    </div>
    <input type="file" id="fileInput" accept=".m3u,.txt"/>
    <div id="playlist"></div>

    <div id="videoModal">
        <div id="videoContainer">
            <button id="castBtn" title="Enviar a Chromecast" style="display:none;">
                <svg viewBox="0 0 24 24"><path d="M1,18 L3,18 C3,19.1 3.9,20 5,20 L5,22 C2.8,22 1,20.2 1,18 Z M1,14 L5,14 C5,16.2 6.8,18 9,18 L9,20 C5.1,20 1,15.9 1,14 Z M1,10 L9,10 C9,13.9 12.1,17 16,17 L16,19 C10.5,19 5,13.5 5,8 L1,8 Z M21,3 L3,3 C1.9,3 1,3.9 1,5 L1,7 L3,7 L3,5 L21,5 L21,19 L15,19 L15,21 L21,21 C22.1,21 23,20.1 23,19 L23,5 C23,3.9 22.1,3 21,3 Z"/></svg>
            </button>
            <button id="closeBtn" title="Cerrar">&times;</button>
            <div id="videoTitle"></div>
            <video id="videoPlayer" controls autoplay playsinline></video>
        </div>
    </div>

    <script>
        // Referencias de elementos
        const fileInput = document.getElementById('fileInput');
        const fileLabel = document.getElementById('fileLabel');
        const playlistDiv = document.getElementById('playlist');
        const videoModal = document.getElementById('videoModal');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoTitleDiv = document.getElementById('videoTitle');
        const closeBtn = document.getElementById('closeBtn');
        const castBtn = document.getElementById('castBtn');
        const clearBtn = document.getElementById('clearBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const saveOnlineBtn = document.getElementById('saveOnlineBtn');

        // Guardado permanente con localStorage
        const STORAGE_KEY = 'm3u_video_list_v2';

        let videos = [];
        let currentVideoIdx = null;

        // Cargar lista de localStorage al inicio
        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    videos = JSON.parse(saved);
                } catch { videos = []; }
            }
            showPlaylist(videos);
        });

        // Guardar en localStorage
        function saveList() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(videos));
        }

        // Chromecast Integración
        let castInitialized = false;
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                cast.framework.CastContext.getInstance().setOptions({
                    receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });
                castInitialized = true;
            }
        };
        function toggleCastBtn(show) {
            castBtn.style.display = show ? 'flex' : 'none';
        }
        async function castCurrentVideo() {
            if (!castInitialized) {
                alert('Chromecast no está disponible en este navegador o aún no se ha cargado el framework.');
                return;
            }
            const video = videos[currentVideoIdx];
            if (!video) return;

            const castContext = cast.framework.CastContext.getInstance();
            const session = castContext.getCurrentSession();
            if (!session) {
                castContext.requestSession().then(() => {
                    setTimeout(() => castCurrentVideo(), 500);
                }).catch((e) => {
                    alert('No se pudo iniciar la sesión de Chromecast: ' + e);
                });
                return;
            }
            const mediaInfo = new chrome.cast.media.MediaInfo(video.url, 'video/mp4');
            mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
            mediaInfo.metadata.title = video.title || 'Vídeo M3U';
            const request = new chrome.cast.media.LoadRequest(mediaInfo);
            session.loadMedia(request).then(
                function() {},
                function(errorCode) {
                    alert('Error enviando vídeo a Chromecast: ' + errorCode);
                }
            );
        }
        castBtn.addEventListener('click', castCurrentVideo);

        // Devuelve solo las URLs únicas
        function dedupeAndMergeVideos(oldList, newList) {
            const urlSet = new Set(oldList.map(v => v.url));
            const deduped = [...oldList];
            for (const v of newList) {
                if (!urlSet.has(v.url)) {
                    deduped.push(v);
                    urlSet.add(v.url);
                }
            }
            return deduped;
        }

        // Parsear el archivo M3U y devolver [{title, url, status}]
        function parseM3U(content) {
            const lines = content.split(/\r?\n/);
            const entries = [];
            let currentTitle = '';
            for (let line of lines) {
                line = line.trim();
                if (line.startsWith('#EXTINF:')) {
                    const parts = line.split(',');
                    currentTitle = parts.length > 1 ? parts[1].trim() : '';
                } else if (line && !line.startsWith('#')) {
                    if (currentTitle) {
                        entries.push({ title: currentTitle, url: line, status: null });
                        currentTitle = '';
                    }
                }
            }
            return entries;
        }

        // Mostrar la lista de vídeos (con estado online/offline si existe)
        function showPlaylist(videos) {
            playlistDiv.innerHTML = '';
            if (videos.length === 0) {
                playlistDiv.innerHTML = '<div style="padding:1em;text-align:center;color:#aaa;">No se encontraron vídeos en el archivo.</div>';
                return;
            }
            videos.forEach((video, idx) => {
                const div = document.createElement('div');
                div.className = 'video-item';
                div.onclick = () => playVideo(idx);

                // Título
                const spanTitle = document.createElement('span');
                spanTitle.textContent = video.title;

                // Estado online/offline
                let statusSpan = '';
                if (video.status === 'online') {
                    statusSpan = document.createElement('span');
                    statusSpan.className = 'status online';
                    statusSpan.textContent = 'Online';
                } else if (video.status === 'offline') {
                    statusSpan = document.createElement('span');
                    statusSpan.className = 'status offline';
                    statusSpan.textContent = 'Offline';
                }

                div.appendChild(spanTitle);
                if (statusSpan) div.appendChild(statusSpan);

                playlistDiv.appendChild(div);
            });
        }

        function playVideo(idx) {
            const video = videos[idx];
            currentVideoIdx = idx;
            videoPlayer.src = video.url;
            videoTitleDiv.textContent = video.title;
            videoModal.style.display = 'flex';
            setTimeout(() => videoPlayer.play(), 100);
            toggleCastBtn(castInitialized && !!video.url);
        }

        function closeModal() {
            videoPlayer.pause();
            videoPlayer.src = '';
            videoModal.style.display = 'none';
            toggleCastBtn(false);
        }

        // Manejo de archivo seleccionado
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const newList = parseM3U(evt.target.result);
                videos = dedupeAndMergeVideos(videos, newList);
                saveList();
                showPlaylist(videos);
            };
            reader.readAsText(file, 'utf-8');
        });

        // Limpiar lista
        clearBtn.addEventListener('click', function() {
            videos = [];
            saveList();
            showPlaylist(videos);
        });

        // Analizar estado online/offline de cada vídeo
        analyzeBtn.addEventListener('click', function() {
            if (videos.length === 0) return;
            let changed = false;
            function checkNext(index) {
                if (index >= videos.length) {
                    if (changed) saveList();
                    showPlaylist(videos);
                    return;
                }
                const v = videos[index];

                // HEAD suele ser bloqueado por CORS, así que se usa fetch GET con 'range' si es posible y timeout propio
                let controller = new AbortController();
                let timeout = setTimeout(() => controller.abort(), 6000); // 6s timeout

                fetch(v.url, {
                    method: 'GET',
                    headers: { 'Range': 'bytes=0-0' },
                    mode: 'cors',
                    signal: controller.signal,
                    cache: 'no-store'
                }).then(resp => {
                        clearTimeout(timeout);
                        // Consideramos online si status 200/206 y tipo de contenido parece vídeo
                        if ((resp.status === 200 || resp.status === 206) &&
                            resp.headers.get('content-type') && resp.headers.get('content-type').startsWith('video')) {
                            if (v.status !== 'online') {
                                v.status = 'online';
                                changed = true;
                            }
                        } else {
                            if (v.status !== 'offline') {
                                v.status = 'offline';
                                changed = true;
                            }
                        }
                        showPlaylist(videos);
                        setTimeout(() => checkNext(index + 1), 200);
                    }).catch(() => {
                        clearTimeout(timeout);
                        if (v.status !== 'offline') {
                            v.status = 'offline';
                            changed = true;
                        }
                        showPlaylist(videos);
                        setTimeout(() => checkNext(index + 1), 200);
                    });
            }
            checkNext(0);
        });

        // Guardar solo los online en formato M3U
        saveOnlineBtn.addEventListener('click', function() {
            const items = videos.filter(v => v.status === 'online');
            if (!items.length) {
                alert('No hay archivos online para guardar.');
                return;
            }
            let m3u = '#EXTM3U\n';
            items.forEach(v => {
                m3u += `#EXTINF:-1,${v.title}\n${v.url}\n`;
            });
            const blob = new Blob([m3u], { type: 'audio/x-mpegurl' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'online.m3u';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                URL.revokeObjectURL(a.href);
                document.body.removeChild(a);
            }, 500);
        });

        // Delegar click en el label al input
        fileLabel.addEventListener('click', function() {
            fileInput.click();
        });

        closeBtn.addEventListener('click', closeModal);
        videoModal.addEventListener('click', function(e) {
            if (e.target === videoModal) closeModal();
        });
        videoModal.addEventListener('touchstart', function() {
            if (videoPlayer.paused) videoPlayer.play();
        }, { once: true });

        // Mensaje de ayuda inicial
        showPlaylist(videos);
    </script>
</body>
</html>
