<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ListaTube Smart TV</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    h1 { text-align: center; }
    .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    iframe { width: 100%; height: 400px; border: none; border-radius: 10px; margin-bottom: 20px; }
    select { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; }
    ul { list-style: none; padding: 0; }
    li { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #ddd; }
    .title { cursor: pointer; flex: 1; padding: 5px; }
    .title.active { background: #c2f0c2; border-radius: 5px; }
    .controls button { margin-left: 5px; border: none; background: #eee; cursor: pointer; font-size: 16px; border-radius: 4px; padding: 3px 6px; }
    .controls button:hover { background: #ccc; }
    .actions { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; }
    .actions button, .actions input[type=file] { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer; }
  </style>
</head>
<body>
<div class="container">
  <h1>ListaTube</h1>

  <!-- Reproductor -->
  <iframe id="player" src="" allowfullscreen></iframe>

  <!-- Selector desplegable -->
  <select id="videoSelect"></select>

  <!-- Listado -->
  <ul id="videoList"></ul>

  <!-- Botones -->
  <div class="actions">
    <button id="exportBtn">Exportar listatube.json</button>
    <input type="file" id="fileInput" accept="application/json">
    <button id="clearBtn">Limpiar Lista</button>
    <button id="updateBtn">Actualizar</button>
  </div>
</div>

<script>
  var UPDATE_URL = "https://yagopc.github.io/Cine/listatube.json";
  var videos = [];
  var currentIndex = -1;

  function saveVideos() {
    try { localStorage.setItem("videos", JSON.stringify(videos)); } catch(e) {}
    renderList();
  }

  function playVideo(index) {
    if (!videos[index]) return;
    currentIndex = index;
    document.getElementById("player").src = videos[index].url;
    renderList();
  }

  function renderList() {
    var list = document.getElementById("videoList");
    var select = document.getElementById("videoSelect");
    list.innerHTML = "";
    select.innerHTML = '<option value="">-- Selecciona un video --</option>';

    videos.forEach(function(video, index) {
      var li = document.createElement("li");
      var span = document.createElement("span");
      span.textContent = video.title;
      span.className = "title" + (index === currentIndex ? " active" : "");
      span.onclick = function() { playVideo(index); };

      var controls = document.createElement("span");
      controls.className = "controls";

      var delBtn = document.createElement("button");
      delBtn.textContent = "ðŸ—‘";
      delBtn.onclick = function() { if(confirm("Eliminar?")) { videos.splice(index,1); saveVideos(); } };

      controls.appendChild(delBtn);
      li.appendChild(span);
      li.appendChild(controls);
      list.appendChild(li);

      var opt = document.createElement("option");
      opt.value = index;
      opt.textContent = video.title;
      if (index === currentIndex) opt.selected = true;
      select.appendChild(opt);
    });
  }

  // Eventos
  document.getElementById("videoSelect").addEventListener("change", function() {
    var i = this.value;
    if (i !== "") playVideo(parseInt(i));
  });

  document.getElementById("clearBtn").addEventListener("click", function() {
    if (confirm("Â¿Vaciar lista?")) { videos = []; saveVideos(); }
  });

  document.getElementById("exportBtn").addEventListener("click", function() {
    try {
      var blob = new Blob([JSON.stringify(videos,null,2)], {type:"application/json"});
      var a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "listatube.json";
      a.click();
    } catch(e) {
      alert("Tu Smart TV no soporta exportaciÃ³n de archivos.");
    }
  });

  document.getElementById("fileInput").addEventListener("change", function(evt) {
    var file = evt.target.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(e) {
      try { videos = JSON.parse(e.target.result); saveVideos(); }
      catch(err) { alert("Archivo invÃ¡lido"); }
    };
    reader.readAsText(file);
  });

  document.getElementById("updateBtn").addEventListener("click", loadFromURL);

  function loadFromURL() {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", UPDATE_URL, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          try {
            videos = JSON.parse(xhr.responseText);
            saveVideos();
          } catch(e) { alert("Error de formato JSON"); }
        } else {
          alert("No se pudo cargar la lista");
        }
      }
    };
    xhr.send();
  }

  // Inicializar
  try {
    var saved = localStorage.getItem("videos");
    if (saved) videos = JSON.parse(saved);
    else loadFromURL(); // si no hay nada en localStorage, cargar de internet
  } catch(e) { loadFromURL(); }

  renderList();
</script>
</body>
</html>
