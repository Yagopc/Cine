<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ListaTube Cine</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; background: #000; color: #fff; }
    h1 { text-align: center; margin-bottom: 15px; }
    .container { max-width: 900px; margin: auto; background: #111; padding: 15px; border-radius: 10px; }
    iframe { width: 100%; height: 480px; border: none; border-radius: 10px; margin-bottom: 15px; background: #000; }
    select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; font-size: 16px; }
    ul { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; margin: 0; }
    li { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; }
    li:hover { background: #444; }
    li.active { background: green; color: #fff; font-weight: bold; }
    .actions { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; }
    .actions button, .actions input[type=file] { flex: 1; padding: 10px; border-radius: 5px; border: none; cursor: pointer; font-size: 16px; }
    .actions button { background: #007BFF; color: white; }
    .actions button:hover { background: #0056b3; }
  </style>
</head>
<body>
<div class="container">
  <h1>ðŸŽ¬ ListaTube Cine</h1>

  <!-- Reproductor -->
  <iframe id="player" allowfullscreen></iframe>

  <!-- Selector -->
  <select id="videoSelect" onchange="playSelected()">
    <option value="">-- Selecciona una pelÃ­cula --</option>
  </select>

  <!-- Listado -->
  <ul id="videoList"></ul>

  <!-- Botones -->
  <div class="actions">
    <button onclick="exportJSON()">ðŸ’¾ Exportar JSON</button>
    <input type="file" id="fileInput" accept="application/json" onchange="importJSON(event)">
    <button onclick="clearList()">ðŸ§¹ Limpiar Lista</button>
    <button onclick="updateFromURL()">ðŸ”„ Actualizar Online</button>
  </div>
</div>

<script>
  const UPDATE_URL = "https://yagopc.github.io/Cine/listatube.json";
  let videos = JSON.parse(localStorage.getItem("videos")) || [];
  let currentIndex = -1;

  // Guardar en localStorage
  function saveVideos() {
    localStorage.setItem("videos", JSON.stringify(videos));
    renderList();
  }

  // Obtener ID de YouTube
  function getVideoId(url) {
    try {
      let u = new URL(url);
      if (u.hostname.includes("youtu.be")) return u.pathname.slice(1);
      if (u.hostname.includes("youtube.com") && u.searchParams.get("v")) return u.searchParams.get("v");
      if (u.pathname.includes("/live/")) return u.pathname.split("/live/")[1];
    } catch { return null; }
    return null;
  }

  // Reproducir vÃ­deo
  function playVideo(index) {
    if (!videos[index]) return;
    currentIndex = index;
    const videoId = getVideoId(videos[index].url);
    const player = document.getElementById("player");

    if (videoId) {
      player.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1&fs=1`;
    } else {
      player.src = videos[index].url;
    }

    renderList();

    // Pantalla completa automÃ¡tica
    setTimeout(() => {
      if (player.requestFullscreen) {
        player.requestFullscreen();
      } else if (player.webkitRequestFullscreen) {
        player.webkitRequestFullscreen();
      } else if (player.msRequestFullscreen) {
        player.msRequestFullscreen();
      }
    }, 500);
  }

  // SelecciÃ³n desde desplegable
  function playSelected() {
    const index = document.getElementById("videoSelect").value;
    if (index !== "") playVideo(index);
  }

  // Eliminar lista completa
  function clearList() {
    if (confirm("Â¿Seguro que quieres borrar toda la lista?")) {
      videos = [];
      saveVideos();
      document.getElementById("player").src = "";
    }
  }

  // Exportar JSON
  function exportJSON() {
    const data = videos.map(v => ({ title: v.title, url: v.url }));
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "listatube.json";
    a.click();
  }

  // Importar JSON
  function importJSON(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        videos = JSON.parse(e.target.result);
        saveVideos();
      } catch {
        alert("Archivo invÃ¡lido");
      }
    };
    reader.readAsText(file);
  }

  // Cargar desde URL online
  async function updateFromURL() {
    try {
      const response = await fetch(UPDATE_URL);
      if (!response.ok) throw new Error("No se pudo cargar el archivo");
      const data = await response.json();
      videos = data;
      saveVideos();
    } catch (e) {
      alert("Error al actualizar: " + e.message);
    }
  }

  // Pintar lista y selector
  function renderList() {
    const list = document.getElementById("videoList");
    const select = document.getElementById("videoSelect");
    list.innerHTML = "";
    select.innerHTML = '<option value="">-- Selecciona una pelÃ­cula --</option>';

    videos.forEach((video, index) => {
      // lista
      const li = document.createElement("li");
      li.textContent = video.title;
      li.onclick = () => playVideo(index);
      if (index == currentIndex) li.classList.add("active");
      list.appendChild(li);

      // desplegable
      const opt = document.createElement("option");
      opt.value = index;
      opt.textContent = video.title;
      if (index == currentIndex) opt.selected = true;
      select.appendChild(opt);
    });
  }

  // Inicializar
  (async () => {
    if (videos.length === 0) {
      await updateFromURL();
    } else {
      renderList();
    }
  })();
</script>
</body>
</html>
