<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">

  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #000; color: #fff; }
    h1 { text-align: center; padding: 15px; font-size: 28px; }
    .container { max-width: 960px; margin: auto; background: #111; padding: 15px; border-radius: 10px; }
    iframe { width: 100%; height: 480px; border: none; border-radius: 10px; margin-bottom: 15px; background: #000; }
    select { width: 100%; padding: 15px; margin: 10px 0; border-radius: 8px; border: none; font-size: 20px; background: #222; color: #fff; }
    ul { list-style: none; padding: 0; max-height: 350px; overflow-y: auto; margin: 0; }
    li { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; font-size: 20px; }
    li:hover, li.focused { background: #444; }
    li.active { background: green !important; color: #fff; font-weight: bold; }
    .actions { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 12px; }
    .actions button, .actions input[type=file] {
      flex: 1 1 45%; padding: 18px; border-radius: 8px; border: none; cursor: pointer; 
      font-size: 20px; background: #007BFF; color: white;
    }
    .actions button:hover { background: #0056b3; }
  </style>
</head>
<body>
<div class="container">
  <h1>üé¨ ListaTube Cine - Smart TV</h1>

  <!-- Reproductor -->
  <iframe id="player" allowfullscreen></iframe>

  <!-- Selector -->
  <select id="videoSelect" onchange="playSelected()">
    <option value="">-- Selecciona una pel√≠cula --</option>
  </select>

  <!-- Listado -->
  <ul id="videoList"></ul>

  <!-- Botones -->
  <div class="actions">
    <button onclick="exportJSON()">üíæ Exportar JSON</button>
    <input type="file" id="fileInput" accept="application/json" onchange="importJSON(event)">
    <button onclick="clearList()">üßπ Limpiar Lista</button>
    <button onclick="updateFromURL()">üîÑ Actualizar Online</button>
  </div>
</div>

<script>
  const UPDATE_URL = "https://yagopc.github.io/Cine/listatube.json";
  let videos = JSON.parse(localStorage.getItem("videos")) || [];
  let currentIndex = -1;
  let focusedIndex = 0;
  let player;

  function saveVideos() {
    localStorage.setItem("videos", JSON.stringify(videos));
    renderList();
  }

  function getVideoId(url) {
    try {
      let u = new URL(url);
      if (u.hostname.includes("youtu.be")) return u.pathname.slice(1);
      if (u.hostname.includes("youtube.com") && u.searchParams.get("v")) return u.searchParams.get("v");
      if (u.pathname.includes("/live/")) return u.pathname.split("/live/")[1];
    } catch { return null; }
    return null;
  }

  function playVideo(index) {
    if (!videos[index]) return;
    currentIndex = index;
    const videoId = getVideoId(videos[index].url);
    player = document.getElementById("player");

    if (videoId) {
      player.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1&enablejsapi=1`;
    } else {
      player.src = videos[index].url;
    }

    renderList();

    setTimeout(() => {
      if (player.requestFullscreen) {
        player.requestFullscreen();
      } else if (player.webkitRequestFullscreen) {
        player.webkitRequestFullscreen();
      } else if (player.msRequestFullscreen) {
        player.msRequestFullscreen();
      }
    }, 500);
  }

  function playSelected() {
    const index = document.getElementById("videoSelect").value;
    if (index !== "") playVideo(index);
  }

  function clearList() {
    if (confirm("¬øSeguro que quieres borrar toda la lista?")) {
      videos = [];
      saveVideos();
      document.getElementById("player").src = "";
    }
  }

  function exportJSON() {
    const data = videos.map(v => ({ title: v.title, url: v.url }));
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "listatube.json";
    a.click();
  }

  function importJSON(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        videos = JSON.parse(e.target.result);
        saveVideos();
      } catch {
        alert("Archivo inv√°lido");
      }
    };
    reader.readAsText(file);
  }

  async function updateFromURL() {
    try {
      const response = await fetch(UPDATE_URL);
      if (!response.ok) throw new Error("No se pudo cargar el archivo");
      const data = await response.json();
      videos = data;
      saveVideos();
    } catch (e) {
      alert("Error al actualizar: " + e.message);
    }
  }

  function renderList() {
    const list = document.getElementById("videoList");
    const select = document.getElementById("videoSelect");
    list.innerHTML = "";
    select.innerHTML = '<option value="">-- Selecciona una pel√≠cula --</option>';

    videos.forEach((video, index) => {
      const li = document.createElement("li");
      li.textContent = video.title;
      li.onclick = () => playVideo(index);
      if (index == currentIndex) li.classList.add("active");
      if (index == focusedIndex) li.classList.add("focused");
      list.appendChild(li);

      const opt = document.createElement("option");
      opt.value = index;
      opt.textContent = video.title;
      if (index == currentIndex) opt.selected = true;
      select.appendChild(opt);
    });
  }

  // üéÆ Soporte mando TV (flechas y Enter)
  document.addEventListener("keydown", (e) => {
    const listItems = document.querySelectorAll("#videoList li");
    if (!listItems.length) return;

    if (e.key === "ArrowDown") {
      focusedIndex = (focusedIndex + 1) % listItems.length;
      renderList();
    } else if (e.key === "ArrowUp") {
      focusedIndex = (focusedIndex - 1 + listItems.length) % listItems.length;
      renderList();
    } else if (e.key === "Enter") {
      playVideo(focusedIndex);
    }
  });

  // ‚ñ∂Ô∏è Autoplay continuo usando API de YouTube
  window.addEventListener("message", function(event) {
    if (event.data && event.data.event === "onStateChange" && event.data.info === 0) {
      // Estado 0 = v√≠deo terminado
      if (currentIndex + 1 < videos.length) {
        playVideo(currentIndex + 1);
      }
    }
  });

  (async () => {
    try {
      await updateFromURL();
    } catch {
      renderList(); // fallback a localStorage
    }
  })();
</script>
</body>
</html>
