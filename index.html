<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reproductor de Películas - Smart TV</title>
    <style>
        :root {
            --bg: #0b0b0b;
            --panel: #161616;
            --muted: #9a9a9a;
            --primary: #4CAF50;
            --white: #f5f5f5;
        }
        * { box-sizing: border-box; }
        body { margin:0; font-family: Arial, Helvetica, sans-serif; background:var(--bg); color:var(--white); }
        .app { padding:20px; display:flex; flex-direction:column; gap:16px; min-height:100vh; }
        .header h1 { margin:0; font-size:28px; text-align:center; }
        .controls { display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap; }
        .btn { background:var(--primary); color:#fff; border:0; padding:12px 18px; border-radius:8px; font-size:18px; cursor:pointer; }
        .btn.secondary { background:var(--panel); border:1px solid #333; }
        .player-wrap { width:100%; max-width:1280px; margin:0 auto; background:#000; border-radius:8px; overflow:hidden; }
        .poster { width:100%; padding-top:56.25%; position:relative; }
        iframe#videoPlayer { position:absolute; left:0; top:0; width:100%; height:100%; border:0; background:#000; }
        .search { display:flex; justify-content:center; margin-top:8px; }
        input#searchInput { min-width:300px; max-width:720px; padding:10px 14px; border-radius:22px; border:0; background:var(--panel); color:var(--white); font-size:16px; }
        select#resolutionSelect { padding:8px 10px; border-radius:8px; background:var(--panel); color:var(--white); border:0; font-size:16px; }
        .list-panel { max-width:1280px; margin:0 auto; background:var(--panel); border-radius:8px; padding:12px; }
        .list-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .movies-list { max-height:42vh; overflow:auto; padding-right:6px; }
        .movie-item { display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:6px; margin-bottom:6px; cursor:pointer; background:transparent; border:2px solid transparent; }
        .movie-item.selected, .movie-item:focus { background: rgba(76,175,80,0.08); border-color: rgba(76,175,80,0.2); outline:none; }
        .movie-title { font-weight:700; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:70%; }
        .movie-genre { color:var(--muted); font-size:14px; margin-left:8px; }
        .movie-actions button { background:transparent; border:0; color:var(--white); font-size:18px; cursor:pointer; padding:8px; border-radius:6px; }
        .no-movies { padding:24px; text-align:center; color:var(--muted); }
        .notification { position:fixed; right:12px; top:12px; background:var(--primary); color:#fff; padding:10px 12px; border-radius:8px; display:none; z-index:999; }
        .notification.show { display:block; }
        @media (max-width:720px) { .header h1 { font-size:20px; } input#searchInput { min-width:200px; } }
    </style>
</head>
<body>
    <div class="app" role="application" aria-label="Reproductor de películas">
        <div class="header"><h1>Reproductor de Películas</h1></div>

        <div class="controls">
            <button id="updateMoviesBtn" class="btn">Actualizar</button>
            <button id="genreFilterBtn" class="btn secondary">Género</button>
            <select id="resolutionSelect" title="Resolución">
                <option value="480">480p</option>
                <option value="720">720p</option>
                <option value="1080">1080p</option>
                <option value="max">Máxima</option>
            </select>
        </div>

        <div id="genreButtons" style="display:none; justify-content:center; gap:8px; max-width:1280px; margin:0 auto;"></div>

        <div class="player-wrap" aria-live="polite">
            <div class="poster">
                <iframe id="videoPlayer" src="" allow="autoplay; fullscreen" allowfullscreen title="Reproductor de video"></iframe>
            </div>
        </div>

        <div class="search">
            <input id="searchInput" type="search" placeholder="Buscar películas..." />
        </div>

        <div class="list-panel" role="region" aria-label="Lista de películas">
            <div class="list-header">
                <h3 style="margin:0;color:var(--primary)">Lista de Películas</h3>
                <div style="color:var(--muted)" id="counts">0 películas | 0 coincidencias</div>
            </div>
            <div class="movies-list" id="moviesList" tabindex="0">
                <div class="no-movies">Cargando...</div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification" role="status" aria-live="polite"></div>

    <script>
    // Compatibilidad: polyfills ligeros
    (function () {
        if (!Element.prototype.matches) {
            Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector || function (s) {
                var matches = (this.document || this.ownerDocument).querySelectorAll(s), i = matches.length;
                while (--i >= 0 && matches.item(i) !== this) {}
                return i > -1;
            };
        }
        if (!Element.prototype.closest) {
            Element.prototype.closest = function (s) {
                var el = this;
                while (el && el.nodeType === 1) {
                    if (el.matches(s)) return el;
                    el = el.parentElement || el.parentNode;
                }
                return null;
            };
        }
        if (typeof NodeList !== 'undefined' && !NodeList.prototype.forEach) {
            NodeList.prototype.forEach = Array.prototype.forEach;
        }
    })();

    (function () {
        // Variables y elementos
        var GENRES = ["Romanos","Aventura","Drama","Ciencia ficción","Policíaca","Western","Suspense","Fantasía","Comedia","Terror"];
        var updateBtn = document.getElementById('updateMoviesBtn');
        var genreFilterBtn = document.getElementById('genreFilterBtn');
        var genreButtons = document.getElementById('genreButtons');
        var resolutionSelect = document.getElementById('resolutionSelect');
        var searchInput = document.getElementById('searchInput');
        var moviesListEl = document.getElementById('moviesList');
        var videoPlayer = document.getElementById('videoPlayer');
        var countsEl = document.getElementById('counts');
        var notification = document.getElementById('notification');

        var movies = []; // array global
        var currentSearch = '';
        var currentGenre = 'all';
        var currentResolution = '480';

        // Inicio
        document.addEventListener('DOMContentLoaded', function () {
            fillGenreButtons();
            movies = loadMoviesFromStorage();
            renderMovies();
            attachHandlers();

            // Si no hay películas, intentar actualizar desde el JSON remoto
            if (movies.length === 0 && !localStorage.getItem('updating')) {
                localStorage.setItem('updating', 'true');
                updateMoviesFromUrl();
            } else {
                localStorage.removeItem('updating');
            }
        });

        function attachHandlers() {
            // Compatibilidad: usar funciones tradicionales
            searchInput.addEventListener('input', function () {
                currentSearch = (this.value || '').toLowerCase();
                renderMovies();
            });

            resolutionSelect.addEventListener('change', function () {
                currentResolution = this.value;
            });

            updateBtn.addEventListener('click', function () {
                updateMoviesFromUrl();
            });

            genreFilterBtn.addEventListener('click', function () {
                genreButtons.style.display = (genreButtons.style.display === 'flex') ? 'none' : 'flex';
            });

            genreButtons.addEventListener('click', function (e) {
                var target = e.target || e.srcElement;
                if (target && target.getAttribute && target.getAttribute('data-genre')) {
                    currentGenre = target.getAttribute('data-genre');
                    // marcar visual
                    var btns = genreButtons.querySelectorAll('button');
                    for (var i = 0; i < btns.length; i++) { btns[i].style.outline = 'none'; }
                    target.style.outline = '2px solid rgba(255,255,255,0.08)';
                    genreButtons.style.display = 'none';
                    renderMovies();
                }
            });

            // Delegación: clic en lista => reproducir o eliminar
            moviesListEl.addEventListener('click', function (e) {
                var target = e.target || e.srcElement;
                // buscar si se hizo clic en botón eliminar
                var delBtn = (target.closest && target.closest('.delete-btn')) || findAncestorByClass(target, 'delete-btn');
                if (delBtn) {
                    e.stopPropagation();
                    var url = delBtn.getAttribute('data-url');
                    deleteMovieByUrl(url);
                    return;
                }
                // buscar el elemento movie-item
                var item = (target.closest && target.closest('.movie-item')) || findAncestorByClass(target, 'movie-item');
                if (item) {
                    // seleccionar visualmente
                    var items = moviesListEl.querySelectorAll('.movie-item');
                    for (var k = 0; k < items.length; k++) {
                        items[k].classList.remove('selected');
                    }
                    item.classList.add('selected');
                    var index = parseInt(item.getAttribute('data-index'), 10);
                    if (!isNaN(index) && movies[index]) {
                        playMovie(movies[index]);
                    }
                }
            });

            // Soporte teclado básico en TV (up/down/enter)
            document.addEventListener('keydown', function (ev) {
                var items = moviesListEl.querySelectorAll('.movie-item');
                if (!items || items.length === 0) return;
                var focusedIndex = -1;
                for (var i = 0; i < items.length; i++) {
                    if (document.activeElement === items[i] || items[i].classList.contains('selected')) {
                        focusedIndex = i; break;
                    }
                }
                // Key codes comunes en TV remotes
                var code = ev.keyCode || ev.which;
                if (code === 40) { // DOWN
                    ev.preventDefault();
                    var next = Math.min(items.length - 1, Math.max(0, focusedIndex + 1));
                    items[next].focus(); items[next].classList.add('selected'); items[next].scrollIntoView({block:'nearest'});
                } else if (code === 38) { // UP
                    ev.preventDefault();
                    var prev = Math.max(0, (focusedIndex === -1 ? 0 : focusedIndex - 1));
                    items[prev].focus(); items[prev].classList.add('selected'); items[prev].scrollIntoView({block:'nearest'});
                } else if (code === 13) { // ENTER
                    ev.preventDefault();
                    var sel = document.activeElement;
                    if (sel && sel.classList && sel.classList.contains('movie-item')) {
                        sel.click();
                    } else if (focusedIndex >= 0 && items[focusedIndex]) {
                        items[focusedIndex].click();
                    }
                }
            });
        }

        // Renders
        function renderMovies() {
            // limpiar lista
            moviesListEl.innerHTML = '';
            var filtered = movies.slice();

            if (currentSearch) {
                var s = currentSearch.toLowerCase();
                var tmp = [];
                for (var i = 0; i < filtered.length; i++) {
                    var t = (filtered[i].title || '').toLowerCase();
                    if (t.indexOf(s) !== -1) tmp.push(filtered[i]);
                }
                filtered = tmp;
            }

            if (currentGenre !== 'all') {
                var tmp2 = [];
                for (var j = 0; j < filtered.length; j++) {
                    if (filtered[j].genre === currentGenre) tmp2.push(filtered[j]);
                }
                filtered = tmp2;
            }

            // actualizar contadores
            countsEl.textContent = movies.length + ' películas | ' + filtered.length + ' coincidencias';

            if (filtered.length === 0) {
                var noMsg = document.createElement('div');
                noMsg.className = 'no-movies';
                if (movies.length === 0) {
                    noMsg.innerText = 'No hay películas en la lista';
                } else {
                    noMsg.innerText = 'No se encontraron coincidencias';
                }
                moviesListEl.appendChild(noMsg);
                return;
            }

            for (var idx = 0; idx < filtered.length; idx++) {
                var m = filtered[idx];
                // Necesitamos el índice global (en el array movies) para poder reproducir correctamente
                var globalIndex = getGlobalIndexForMovie(m);
                var div = document.createElement('div');
                div.className = 'movie-item';
                div.setAttribute('tabindex', '0');
                div.setAttribute('data-index', globalIndex);
                div.innerHTML =
                    '<div style="display:flex;align-items:center;gap:8px;min-width:0">' +
                        '<div style="width:56px;height:36px;background:#000;border-radius:6px;display:flex;align-items:center;justify-content:center;color:var(--muted)">▶</div>' +
                        '<div style="min-width:0">' +
                            '<div class="movie-title">' + escapeHtml(m.title || 'Sin título') + '</div>' +
                            '<div class="movie-genre">' + escapeHtml(m.genre || '') + '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="movie-actions">' +
                        '<button class="delete-btn" data-url="' + escapeHtmlAttr(m.url || '') + '" title="Eliminar">🗑</button>' +
                    '</div>';
                moviesListEl.appendChild(div);
            }
        }

        // Helpers
        function getGlobalIndexForMovie(movie) {
            for (var i = 0; i < movies.length; i++) {
                if (movies[i].url === movie.url && movies[i].title === movie.title) return i;
            }
            return -1;
        }

        function loadMoviesFromStorage() {
            try {
                var raw = localStorage.getItem('peliculas');
                if (!raw) return [];
                var parsed = JSON.parse(raw);
                if (!Array.isArray(parsed)) return [];
                for (var i = 0; i < parsed.length; i++) {
                    var pm = parsed[i];
                    pm.addedAt = pm.addedAt || new Date().toISOString();
                    pm.platform = pm.platform || detectPlatform(pm.url || '');
                    pm.genre = pm.genre || 'Aventura';
                    pm.embedUrl = pm.embedUrl || convertToEmbedUrl(pm.url || '');
                }
                return parsed;
            } catch (e) {
                console.warn('Error parseando storage:', e);
                return [];
            }
        }

        function saveMoviesToStorage(arr) {
            try {
                arr.sort(function (a, b) {
                    var ta = (a.title || '').toLowerCase();
                    var tb = (b.title || '').toLowerCase();
                    return ta < tb ? -1 : (ta > tb ? 1 : 0);
                });
                localStorage.setItem('peliculas', JSON.stringify(arr));
            } catch (err) {
                showNotification('Error guardando: almacenamiento lleno', 'error');
            }
        }

        function deleteMovieByUrl(url) {
            if (!confirm('¿Eliminar esta película?')) return;
            var newArr = [];
            for (var i = 0; i < movies.length; i++) {
                if (movies[i].url !== url) newArr.push(movies[i]);
            }
            movies = newArr;
            saveMoviesToStorage(movies);
            renderMovies();
            showNotification('Película eliminada');
        }

        function playMovie(movie) {
            if (!movie || !movie.url) return;
            var embed = convertToEmbedUrl(movie.url);
            // Intentar autoplay en mute (muchas TV requieren mute para autoplay)
            var separator = (embed.indexOf('?') !== -1) ? '&' : '?';
            var url = embed + separator + 'autoplay=1&mute=1';
            // Ajustar resolución si es youtube/dailymotion
            url = adjustResolution(url, currentResolution);
            videoPlayer.src = url;
            showNotification('Reproduciendo: ' + (movie.title || ''));
        }

        function detectPlatform(url) {
            if (!url) return 'unknown';
            if (url.indexOf('youtube.com') !== -1 || url.indexOf('youtu.be') !== -1) return 'youtube';
            if (url.indexOf('dailymotion.com') !== -1 || url.indexOf('dai.ly') !== -1) return 'dailymotion';
            if (url.indexOf('ok.ru') !== -1 || url.indexOf('odnoklassniki.ru') !== -1) return 'ok';
            return 'unknown';
        }

        function convertToEmbedUrl(url) {
            if (!url) return '';
            if (url.indexOf('embed') !== -1) return url;
            var platform = detectPlatform(url);
            try {
                if (platform === 'youtube') {
                    var match = url.match(/^.*(youtu.be\/|v\/|u\/\\w\/|embed\/|watch\\?v=|&v=)([^#&?]*).*/);
                    var id = '';
                    if (match && match[2]) id = match[2];
                    if (!id && url.indexOf('youtu.be/') !== -1) id = url.split('youtu.be/')[1].split(/[?&]/)[0];
                    if (id) return 'https://www.youtube.com/embed/' + id;
                }
                if (platform === 'dailymotion') {
                    var m = url.match(/^.+dailymotion.com\/(video|hub)\/([^_]+)[^#]*(#video=([^_&]+))?/);
                    if (m) {
                        var vid = m[4] || m[2];
                        return 'https://www.dailymotion.com/embed/video/' + vid;
                    } else if (url.indexOf('dai.ly/') !== -1) {
                        var id2 = url.split('dai.ly/')[1].split(/[?&]/)[0];
                        return 'https://www.dailymotion.com/embed/video/' + id2;
                    }
                }
                if (platform === 'ok') {
                    if (url.indexOf('video/') !== -1) {
                        var parts = url.split('video/');
                        if (parts.length > 1) {
                            var vidok = parts[1].split('/')[0].split('?')[0];
                            return 'https://ok.ru/videoembed/' + vidok;
                        }
                    }
                }
            } catch (e) {
                // ignore and return original
            }
            return url;
        }

        function adjustResolution(url, resolution) {
            if (!url) return url;
            if (url.indexOf('youtube.com/embed') !== -1) {
                if (resolution === '480') return appendParam(url, 'vq=large');
                if (resolution === '720') return appendParam(url, 'vq=hd720');
                if (resolution === '1080') return appendParam(url, 'vq=hd1080');
                return url;
            }
            if (url.indexOf('dailymotion.com/embed') !== -1) {
                if (resolution === '480') return appendParam(url, 'quality=480');
                if (resolution === '720') return appendParam(url, 'quality=720');
                if (resolution === '1080') return appendParam(url, 'quality=1080');
                return url;
            }
            return url;
        }

        function appendParam(url, param) {
            if (!param) return url;
            return url + ((url.indexOf('?') !== -1) ? '&' : '?') + param;
        }

        function updateMoviesFromUrl() {
            var remote = 'https://yagopc.github.io/Cine/peliculas.json';
            showNotification('Actualizando películas...', 'info');
            localStorage.removeItem('peliculas');
            localStorage.setItem('updating', 'true');

            // Intento fetch con timeout simple
            var timedOut = false;
            var timer = setTimeout(function () { timedOut = true; showNotification('Tiempo de espera agotado', 'error'); localStorage.removeItem('updating'); renderMovies(); }, 15000);

            try {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', remote, true);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState !== 4) return;
                    clearTimeout(timer);
                    if (timedOut) return;
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            if (!Array.isArray(data)) throw new Error('Formato inválido');
                            for (var i = 0; i < data.length; i++) {
                                var mm = data[i];
                                mm.addedAt = mm.addedAt || new Date().toISOString();
                                mm.platform = mm.platform || detectPlatform(mm.url || '');
                                mm.genre = mm.genre || 'Aventura';
                                mm.embedUrl = mm.embedUrl || convertToEmbedUrl(mm.url || '');
                            }
                            movies = data;
                            saveMoviesToStorage(movies);
                            renderMovies();
                            showNotification('Se actualizaron ' + movies.length + ' películas', 'success');
                            localStorage.removeItem('updating');
                        } catch (err) {
                            showNotification('Error procesando JSON: ' + (err.message || ''), 'error');
                            localStorage.removeItem('updating');
                            renderMovies();
                        }
                    } else {
                        showNotification('Error cargando remoto (' + xhr.status + ')', 'error');
                        localStorage.removeItem('updating');
                        renderMovies();
                    }
                };
                xhr.send();
            } catch (e) {
                clearTimeout(timer);
                showNotification('Error actualizando: ' + (e.message || ''), 'error');
                localStorage.removeItem('updating');
                renderMovies();
            }
        }

        function showNotification(msg, type) {
            notification.innerText = msg;
            notification.style.background = (type === 'error') ? '#f44336' : (type === 'info' ? '#2196F3' : '#4CAF50');
            notification.className = 'notification show';
            setTimeout(function () { notification.className = 'notification'; }, 3000);
        }

        // util: find ancestor by class (compat)
        function findAncestorByClass(el, cls) {
            while (el) {
                if (el.classList && el.classList.contains(cls)) return el;
                el = el.parentNode;
            }
            return null;
        }

        // util: escape
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/[&<>"']/g, function (m) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
            });
        }
        function escapeHtmlAttr(str) {
            return escapeHtml(str).replace(/"/g, '&quot;');
        }

    })();
    </script>
</body>
</html>